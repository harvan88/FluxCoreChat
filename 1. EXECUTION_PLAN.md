# Plan T√©cnico de Ejecuci√≥n para FluxCore

> **Documento de Implementaci√≥n derivado del TOTEM**  
> Fecha: 2024-12-06  
> Este documento traduce la visi√≥n en tareas ejecutables.

---

## Backlog Estructurado por Hitos

### Estado verificado 2026-01-25 (Alineaci√≥n OpenAI)

| Hito | Situaci√≥n actual | Evidencia |
|------|------------------|-----------|
| FC-OPENAI-MIRROR ‚Äì OpenAI Vector Stores Mirroring | ‚úÖ Completado. Espejo 1:1 con OpenAI implementado. Auto-save, resoluci√≥n de nombres reales, pol√≠ticas de expiraci√≥n simplificadas y ecosistema de asistentes vinculados. | Build verificado 2026-01-25 |

### Estado verificado 2026-01-27 (Account Deletion Agent)

| Hito | Situaci√≥n actual | Evidencia |
|------|------------------|-----------|
| AD-100 ‚Äì Guardianes y Prohibiciones Absolutas | ‚úÖ Completado. `protected_accounts` catalogado v√≠a `seed:protected-accounts`, guard reutilizable (`ensureAccountDeletionAllowed`) integrado en worker y pruebas unitarias Vitest. | `packages/db/src/seed-protected-accounts.ts`, `apps/api/src/services/account-deletion.guard.ts`, `apps/api/src/workers/account-deletion.worker.ts`, `apps/api/src/services/account-deletion.guard.test.ts` |
| AD-110 ‚Äì Autorizaci√≥n Formal | üü° En progreso. Falta middleware `requireAccountDeletionAuth` integrado en rutas `/accounts/:id/delete/*`, verificaci√≥n autom√°tica de `ACCOUNT_DELETE_FORCE` en seeds/UI y pruebas de integraci√≥n (403/401). | `apps/api/src/routes/accounts.routes.ts`, `apps/api/src/middleware/account-deletion-auth.ts`, `packages/db/src/seed-system-admins.ts` |

### Estado verificado 2026-01-14 (FluxCore Fase 2 - Audit Completo)

| Hito | Situaci√≥n actual | Evidencia |
|------|------------------|-----------|
| FC-AI-UX ‚Äì FluxCore UX Tabs + CRUD | ‚úÖ Completado. Tabs lista/detalle sin duplicados (toggle) + CRUD real implementado para asistentes/instrucciones/vector stores. Autosave funcional. Sistema cumple 100% especificaci√≥n FLUX CORE.md. | `apps/web/src/components/fluxcore/FluxCoreSidebar.tsx`, `apps/web/src/components/fluxcore/views/AssistantsView.tsx`, `apps/web/src/components/fluxcore/views/InstructionsView.tsx`, `apps/web/src/components/fluxcore/views/VectorStoresView.tsx`, `apps/api/src/routes/fluxcore.routes.ts` (905 l√≠neas), `docs/FLUXCORE_UI_AUDIT_2026-01-14.md` |
| FC-REALIGN ‚Äì FluxCore como Extensi√≥n (correcci√≥n de rumbo) | üü° En progreso. Eliminado hardcode IA/UI/welcome en core y movido a boundary `extensionHost` + manifests. Pendiente: ejecutar IA como extensi√≥n real via `IExtension` y verificaci√≥n runtime de criterios. | `apps/api/src/services/extension-host.service.ts`, `apps/api/src/core/message-core.ts`, `apps/api/src/websocket/ws-handler.ts`, `apps/api/src/services/account.service.ts`, `apps/api/src/services/auth.service.ts`, `apps/web/src/components/layout/Sidebar.tsx`, `apps/web/src/components/panels/DynamicContainer.tsx` |

### Estado verificado 2026-01-08 (HCI Fase 1)

| Hito | Situaci√≥n actual | Evidencia |
|------|------------------|-----------|
| FC-TRANSFORM ‚Äì FluxCore Identity | ‚úÖ Completado. FluxCore renombrado a FluxCore. Cuenta de sistema migrada de @fluxi a @fluxcore. Componentes UI nuevos: CollapsibleSection, SliderInput. | Build verificado |
| FC-ARCH ‚Äì FluxCore Architecture | ‚úÖ Completado. Implementada arquitectura completa de Asistentes IA seg√∫n documento de visi√≥n. Schema DB, API REST, Frontend con Sidebar y vistas. | Build verificado 2026-01-08 |
| 10R ‚Äì Production Ready | ‚úÖ Completado. Sistema de administradores con `system_admins`, scopes granulares (`credits`, `policies`, `*`), endpoints `/internal/system-admins/*`. Sin dependencia de variables de entorno. | Build verificado 2026-01-08 |
| 12R ‚Äì Smart Delay UX | ‚úÖ Completado (ya implementado). WebSocket maneja eventos `auto_waiting/typing/sending`, `autoReplyStore` gestiona estados, ChatView muestra banners con countdown. | @apps/web/src/hooks/useWebSocket.ts#171-193 |
| 13R ‚Äì UI Protocol | ‚úÖ Completado. `docs/UI_PROTOCOL_STRICT.md` creado con 12 secciones. ViewPort previene tabs cross-account autom√°ticamente. | Build verificado 2026-01-08 |

#### Hito FC-AI-UX ‚Äì FluxCore UX Tabs + CRUD ‚úÖ COMPLETADO (2026-01-14)

**Objetivo:** Alinear el comportamiento de FluxCore con `FLUX CORE.md` para que todos los items del sidebar:
- Abren un **tab de lista** con icono sem√°ntico
- Abren un **tab de detalle** (mismo icono) con t√≠tulo din√°mico
- **No permiten duplicados** (si existe se enfoca; si est√° activo+en foco, se cierra)

**Implementaci√≥n verificada:**
- ‚úÖ Tabs FluxCore con iconos sem√°nticos (Lucide) - 7 secciones seg√∫n especificaci√≥n
- ‚úÖ Asistentes: CRUD completo + autosave + arquitectura de composici√≥n por referencia
- ‚úÖ Instrucciones: CRUD completo + editor con n√∫meros de l√≠nea + l√≠mite 5000 chars
- ‚úÖ Vector Stores: CRUD completo + pol√≠tica de expiraci√≥n + secciones colapsables
- ‚úÖ Tools: Listado de definiciones + conexiones por cuenta
- ‚úÖ API REST completa: 20 endpoints implementados en `fluxcore.routes.ts`
- ‚úÖ Patr√≥n list ‚Üí detail implementado consistentemente
- ‚úÖ Toggle sin duplicados verificado en `Sidebar.tsx:131-153`

**Pendientes menores (no bloqueantes):**
- üü° Vector store files: UI real para `/vector-stores/:id/files` (bot√≥n existe, falta modal upload)
- üü° Unificar editor de Instrucciones con editor de contexto IA del perfil (mejora UX)

**Evidencia de cumplimiento:**
- Auditor√≠a completa: `docs/FLUXCORE_UI_AUDIT_2026-01-14.md`
- 8/8 criterios de aceptaci√≥n cumplidos
- 100% conforme con especificaci√≥n FLUX CORE.md

#### Hito FC-REALIGN ‚Äì FluxCore como Extensi√≥n (EN PROGRESO 2026-01-11)

**Objetivo:** Restaurar el principio TOTEM: **el chat core es autocontenido y agn√≥stico a extensiones**. FluxCore (IA + UI administrativa) debe operar como **extensi√≥n preinstalada y activa por defecto**, con enable/disable y ciclo de vida, sin que el core dependa de ella.

**Estado actual (evidencia en c√≥digo, actualizado a la realidad):**
- ‚úÖ `apps/api/src/core/message-core.ts` ya NO importa `aiService`; delega delay/generaci√≥n/branding v√≠a `extensionHost`.
- ‚úÖ `apps/api/src/websocket/ws-handler.ts` ya NO importa `aiService`; usa `extensionHost` para sugerencias + branding.
- ‚úÖ `apps/api/src/services/account.service.ts` ya NO hardcodea `@fluxcore/fluxcore`; instala extensiones preinstaladas v√≠a `extensionHost.installPreinstalledExtensions(accountId)`.
- ‚úÖ `apps/api/src/services/auth.service.ts` ya NO crea welcome FluxCore con l√≥gica propia; delega v√≠a `extensionHost.tryCreateWelcomeConversation` (best-effort).
- Nota: `apps/api/src/services/ai.service.ts` sigue importando runtime desde `extensions/fluxcore/src` (paso intermedio; pendiente migrarlo a ejecuci√≥n real v√≠a `IExtension`).
- Frontend:
  - ‚úÖ `apps/web/src/components/layout/Sidebar.tsx` ya NO hardcodea IDs de extensi√≥n; decide comportamiento por `manifest.ui.panel.component`.
  - ‚úÖ `apps/web/src/components/panels/DynamicContainer.tsx` ya NO usa `@fluxcore/fluxcore` ni `includes('fluxcore')`; decide render por `manifest.ui.panel.component`.
  - ‚úÖ `apps/web/src/components/extensions/ExtensionConfigPanel.tsx` ya NO usa `fluxcore` string checks; usa flag gen√©rico `supportsPromptInspector`.

**Criterios de aceptaci√≥n (medibles):**
- [ ] El core de chat funciona sin `@fluxcore/fluxcore` instalada (enviar/recibir mensajes, WS `message:new`).
- [ ] Si `@fluxcore/fluxcore` est√° deshabilitada, el core NO dispara IA (ni suggestions ni auto-reply) y no hay errores.
- [ ] Si `@fluxcore/fluxcore` est√° habilitada, la IA funciona (suggest/auto) **v√≠a ExtensionHost** y no v√≠a import directo desde `MessageCore`/`ws-handler`.
- [x] La UI de FluxCore se abre como extensi√≥n (sin condicionales especiales por `extensionId` en Sidebar/DynamicContainer; usa `manifest.ui.panel.component`).
- [x] Registro de cuenta NO depende de FluxCore: el welcome es best-effort y est√° gated por instalaci√≥n/enable.

**Tareas propuestas (migraci√≥n gradual, sin perder trabajo):**
- **FC-REALIGN-100** Documentar mapeo de acoplamientos y contratos a reemplazar (completado en auditor√≠a inicial).
- **FC-REALIGN-110 (Backend)** Ejecutar extensiones reales (al menos `@fluxcore/fluxcore`) usando `IExtension` (pendiente).
- **FC-REALIGN-111 (Backend)** Remover dependencia directa `MessageCore -> aiService` (‚úÖ realizado; ahora usa `extensionHost`).
- **FC-REALIGN-112 (Backend/WS)** Remover dependencia directa `ws-handler -> aiService` (‚úÖ realizado; ahora usa `extensionHost`).
- **FC-REALIGN-113 (Backend/Accounts)** Reemplazar preinstalaci√≥n hardcodeada por `extensionHost.installPreinstalledExtensions(accountId)` (‚úÖ realizado).
- **FC-REALIGN-114 (Backend/Welcome)** Mover bienvenida a hook de extensi√≥n (üü° parcial: ahora es best-effort v√≠a `extensionHost.tryCreateWelcomeConversation`; pendiente mover a lifecycle real de `IExtension`).
- **FC-REALIGN-115 (Frontend)** Eliminar hardcode de `@fluxcore/fluxcore` en UI (‚úÖ realizado; ahora resuelve por `manifest.ui.panel.component` + flags gen√©ricos).

**Gu√≠a de verificaci√≥n (manual + build):**
1. Deshabilitar `@fluxcore/fluxcore` para una cuenta y verificar:
   - enviar mensaje ‚Üí persiste y se emite `message:new`.
   - no aparecen eventos `suggestion:*`.
2. Habilitar `@fluxcore/fluxcore` y verificar:
   - `suggestion:request` produce sugerencia.
   - en modo autom√°tico, se env√≠a auto-reply respetando delay.
3. Ejecutar `bun run build` en la ra√≠z del repo.

**Verificaci√≥n realizada:**
- ‚úÖ `bun run build` exitoso (2026-01-11).

#### Hito FC-TRANSFORM ‚Äì FluxCore Identity (COMPLETADO 2026-01-08)
**Objetivo:** Transformar FluxCore en FluxCore como √∫nica extensi√≥n preinstalada por defecto.

**Cambios realizados:**
- ‚úÖ Renaming completo: "FluxCore" ‚Üí "FluxCore" en manifest, servicios, frontend
- ‚úÖ Metadata de mensajes: `__coreIa` ‚Üí `__fluxcore`
- ‚úÖ Branding: "(gestionado por FluxCore)" en mensajes IA
- ‚úÖ Cuenta de sistema: `@fluxi` ‚Üí `@fluxcore` (seed actualizado)
- ‚úÖ Frontend: `FluxiAvatar` ‚Üí `FluxCoreAvatar`, WelcomeMessage actualizado
- ‚úÖ Componentes UI nuevos: `CollapsibleSection`, `SliderInput`
- ‚úÖ QUICK_START.md actualizado con arquitectura de layout
- ‚úÖ Build verificado exitosamente

#### Hito FC-ARCH ‚Äì FluxCore Architecture (COMPLETADO 2026-01-08)
**Objetivo:** Implementar arquitectura completa de Asistentes IA seg√∫n documento de visi√≥n.

**Schema DB creado:**
- `fluxcore_assistants` - Asistentes IA configurables con modelConfig y timingConfig
- `fluxcore_instructions` - Instrucciones del sistema (system prompts)
- `fluxcore_vector_stores` - Bases de conocimiento vectorizadas
- `fluxcore_vector_store_files` - Archivos en vector stores
- `fluxcore_tool_definitions` - Definiciones de herramientas
- `fluxcore_tool_connections` - Conexiones de herramientas por cuenta
- `fluxcore_assistant_tools` - Relaci√≥n asistentes-herramientas

**API REST implementada:**
- `/api/fluxcore/assistants` - CRUD completo
- `/api/fluxcore/instructions` - CRUD completo
- `/api/fluxcore/vector-stores` - CRUD completo + archivos
- `/api/fluxcore/tools` - Definiciones y conexiones

**Frontend implementado:**
- `FluxCoreSidebar` - Navegaci√≥n con 7 secciones
- `FluxCorePanel` - Panel principal integrado en DynamicContainer
- `AssistantsView` - Listado y gesti√≥n de asistentes
- `InstructionsView` - Editor de instrucciones con vista previa
- `VectorStoresView` - Gesti√≥n de bases de conocimiento
- `ToolsView` - Herramientas agrupadas por categor√≠a
- `UsageView` - Dashboard de m√©tricas

**Integraci√≥n:**
- FluxCorePanel accesible desde extensi√≥n fluxcore con `view='fluxcore'`
- Componentes UI reutilizables: CollapsibleSection, SliderInput

#### Hito 10R ‚Äì Seguridad de Cr√©ditos (COMPLETADO 2026-01-08)
**Objetivo:** Eliminar dependencia de `INTERNAL_API_KEY` y migrar a roles persistidos en BD.

**Implementaci√≥n:**
- ‚úÖ Sistema de administradores ampliado en `system-admin.service.ts`:
  - `grantAdmin(userId, scopes, createdBy)` - Otorgar privilegios
  - `revokeAdmin(userId)` - Revocar privilegios
  - `listAdmins()` - Listar todos con join a accounts
  - `updateScopes(userId, scopes)` - Actualizar permisos
- ‚úÖ Rutas API en `/internal/system-admins/*`:
  - `GET /` - Listar administradores (requiere scope `*`)
  - `POST /grant` - Otorgar privilegios (requiere scope `*`)
  - `DELETE /:userId` - Revocar privilegios (requiere scope `*`)
  - `PATCH /:userId/scopes` - Actualizar scopes (requiere scope `*`)
- ‚úÖ Migraci√≥n de `/internal/credits/*`:
  - Reemplazado `isInternalRequest(INTERNAL_API_KEY)` por `hasInternalAccess(userId, scope)`
  - `/grant-by-query` requiere scope `credits`
  - `/grant/:accountId` requiere scope `credits`
  - `/policies` requiere scope `policies`
- ‚úÖ Validaci√≥n por scopes granulares:
  - `credits` - Gesti√≥n de cr√©ditos
  - `policies` - Gesti√≥n de pol√≠ticas
  - `*` - Super admin (puede gestionar otros admins)

**Archivos modificados:**
- `apps/api/src/services/system-admin.service.ts` - CRUD completo
- `apps/api/src/routes/system-admin.routes.ts` - Rutas internas (nuevo)
- `apps/api/src/routes/internal-credits.routes.ts` - Migrado a scopes
- `apps/api/src/server.ts` - Registro de systemAdminRoutes

**Verificaci√≥n:**
- Build exitoso
- Endpoints documentados en Swagger (tags: System Admins)
- Sin dependencia de variables de entorno para permisos cr√≠ticos

#### Hito 12R ‚Äì Smart Delay UX (COMPLETADO - Ya implementado)
**Objetivo:** Mostrar indicadores visuales de delay autom√°tico seg√∫n eventos del backend.

**Estado actual (verificado 2026-01-08):**
- ‚úÖ `useWebSocket` ya maneja todos los eventos necesarios:
  - `suggestion:auto_waiting` ‚Üí callback `onSuggestionAutoWaiting`
  - `suggestion:auto_typing` ‚Üí callback `onSuggestionAutoTyping`
  - `suggestion:auto_sending` ‚Üí callback `onSuggestionAutoSending`
  - `suggestion:auto_cancelled` ‚Üí callback `onSuggestionAutoCancelled`
- ‚úÖ `autoReplyStore` (Zustand) gestiona estados por conversaci√≥n:
  - Phases: `waiting`, `typing`, `sending`
  - ETA tracking con countdown en UI
  - M√©todos: `setWaitingBySuggestion`, `setTypingBySuggestion`, `setSendingBySuggestion`
- ‚úÖ `ChatView` muestra banner de estado autom√°tico:
  - Mensaje descriptivo seg√∫n phase
  - Countdown visual con segundos restantes
  - Bot√≥n de cancelar que elimina sugerencia
- ‚úÖ `ParticipantsActivityBar` muestra "escribiendo..." cuando otros usuarios act√∫an

**Archivos clave:**
- `apps/web/src/hooks/useWebSocket.ts` (l√≠neas 171-193)
- `apps/web/src/store/autoReplyStore.ts` (completo)
- `apps/web/src/components/chat/ChatView.tsx` (l√≠neas 525-545)

**Conclusi√≥n:** El sistema Smart Delay ya est√° completamente funcional. El backend emite los eventos, el frontend los procesa y muestra indicadores visuales apropiados.

#### Hito 13R ‚Äì UI Protocol & Sidebar Enforcement (COMPLETADO 2026-01-08)
**Objetivo:** Documentar y hacer cumplir el protocolo estricto de UI.

**Documentaci√≥n creada:**
- ‚úÖ `docs/UI_PROTOCOL_STRICT.md` - 12 secciones detalladas:
  1. Arquitectura General (diagrama)
  2. Activity Bar - Responsabilidades y prohibiciones
  3. Sidebar - Elementos permitidos (280px ancho ideal)
  4. Dynamic Container - Contenido principal
  5. Flujo de datos entre componentes
  6. Context Isolation por cuenta
  7. Extensiones y plugins
  8. Estados globales (uiStore, panelStore)
  9. Responsive behavior
  10. Checklist de cumplimiento
  11. Ejemplos de violaciones comunes
  12. Auditor√≠a peri√≥dica

**Implementaci√≥n de protecci√≥n:**
- ‚úÖ `ViewPort.tsx` - Prevenci√≥n de tabs cross-account:
  - Detecta cambio de `selectedAccountId`
  - Cierra autom√°ticamente tabs con `context.accountId` diferente
  - Evita que datos de una cuenta persistan al cambiar
- ‚úÖ Refs para evitar race conditions en apertura de tabs
- ‚úÖ Cleanup autom√°tico al desmontar

**Archivos modificados:**
- `docs/UI_PROTOCOL_STRICT.md` (nuevo, 300+ l√≠neas)
- `apps/web/src/components/layout/ViewPort.tsx` (l√≠neas 21-35)

### Hito 0: Bootstrap del Monorepo

**Duraci√≥n:** 2-3 d√≠as

| ID | Descripci√≥n | Prioridad | Componentes |
|----|-------------|-----------|-------------|
| FC-001 | Inicializar monorepo con Bun workspaces | Alta | Infra |
| FC-002 | Configurar Turbo para build orchestration | Alta | Infra |
| FC-003 | Crear package `@fluxcore/types` | Alta | Shared |
| FC-004 | Crear package `@fluxcore/db` con Drizzle | Alta | Backend |
| FC-005 | Setup ESLint + Prettier compartido | Media | Infra |
| FC-006 | Crear app `api` con Elysia b√°sico | Alta | Backend |
| FC-007 | Crear app `web` con Vite + React | Alta | Frontend |
| FC-008 | Configurar variables de entorno | Media | Infra |

---

### Hito 1: Fundamentos de Identidad

**Duraci√≥n:** 2 semanas

**Puntos clave:**
- `ai_settings` se configura v√≠a extensi√≥n `@fluxcore/fluxcore`
- `private_context` es accesible para extensiones con permiso

| ID | Descripci√≥n | Prioridad | Dependencias | Notas |
|----|-------------|-----------|--------------|-------|
| FC-010 | Schema SQL: `users` | Alta | FC-004 | - |
| FC-011 | Schema SQL: `accounts` (sin ai_settings) | Alta | FC-010 | ai_settings va en extensi√≥n |
| FC-012 | Schema SQL: `actors` | Alta | FC-010 | - |
| FC-013-030 | Auth endpoints + Frontend | Alta | - | - |

**Schema `accounts`:**
```sql
CREATE TABLE accounts (
  id UUID PRIMARY KEY,
  owner_user_id UUID NOT NULL REFERENCES users(id),
  username VARCHAR(100) UNIQUE NOT NULL,
  display_name VARCHAR(255) NOT NULL,
  account_type VARCHAR(20) NOT NULL,
  profile JSONB DEFAULT '{}'::jsonb,
  private_context TEXT CHECK (length(private_context) <= 5000),
  -- SIN ai_settings (va en extension_installations)
  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);
```

---

### Hito 2: Chat Core

**Duraci√≥n:** 2 semanas

**Puntos clave:**
- Contexto relacional unificado con autor√≠a
- MessageCore delega a extensiones (sin IA embebida)

| ID | Descripci√≥n | Prioridad | Dependencias | Notas |
|----|-------------|-----------|--------------|-------|
| FC-040 | Schema SQL: `relationships` con contexto unificado | Alta | FC-011 | Contexto estructurado con autor√≠a |
| FC-041 | Schema SQL: `conversations` | Alta | FC-040 | - |
| FC-042 | Schema SQL: `messages` | Alta | FC-041 | - |
| FC-043 | Schema SQL: `message_enrichments` | Media | FC-042 | - |
| FC-050 | MessageCore service (delega a extensiones) | Alta | FC-049 | Sin IA embebida |
| FC-044-066 | Endpoints + WebSocket + Frontend | Alta | - | - |

**Schema `relationships`:**
```sql
CREATE TABLE relationships (
  id UUID PRIMARY KEY,
  account_a_id UUID NOT NULL REFERENCES accounts(id),
  account_b_id UUID NOT NULL REFERENCES accounts(id),
  
  -- Perspectivas bilaterales (sin contexto)
  perspective_a JSONB DEFAULT '{"saved_name": null, "tags": [], "status": "active"}'::jsonb,
  perspective_b JSONB DEFAULT '{"saved_name": null, "tags": [], "status": "active"}'::jsonb,
  
  -- Contexto UNIFICADO con autor√≠a
  context JSONB DEFAULT '{"entries": [], "total_chars": 0}'::jsonb,
  
  created_at TIMESTAMP DEFAULT now(),
  last_interaction TIMESTAMP,
  UNIQUE(account_a_id, account_b_id)
);
```

**MessageCore:**
```typescript
class MessageCore {
  constructor(
    private persistence: IPersistenceService,
    private notifications: INotificationService,
    private extensionHost: IExtensionHost
    // SIN integratedAI
  ) {}

  async receive(envelope: MessageEnvelope): Promise<ReceiveResult> {
    await this.persistence.save(envelope);
    await this.notifications.broadcast(envelope);
    
    if (envelope.type === 'incoming') {
      // Delegar TODO a extensiones (incluyendo @fluxcore/fluxcore)
      await this.extensionHost.processMessage(envelope);
    }
    
    return { success: true, messageId: envelope.id };
  }
}
```

---

### Hito 3: Workspace UI

**Duraci√≥n:** 2 semanas

| ID | Descripci√≥n | Prioridad |
|----|-------------|-----------|
| FC-080-097 | Panel Stack Manager, ActivityBar, Sidebar, ViewPort, etc. | Alta |

---

### Hito 4: Sistema de Extensiones

**Duraci√≥n:** 2 semanas

**Puntos clave:**
- Tabla `extension_contexts` para Context Overlays
- Permisos de contexto granulares
- Debe completarse antes de implementar @fluxcore/fluxcore

| ID | Descripci√≥n | Prioridad | Dependencias | Notas |
|----|-------------|-----------|--------------|-------|
| FC-150 | Schema SQL: `extension_installations` | Alta | FC-011 | - |
| FC-151 | Schema SQL: `extension_contexts` | Alta | FC-150 | Context Overlays |
| FC-152 | Interface IExtension | Alta | FC-003 | - |
| FC-153 | Interface IExtensionManifest con permisos | Alta | FC-152 | Incluye permisos de contexto |
| FC-154 | ExtensionHost service | Alta | FC-153 | - |
| FC-155 | ManifestLoader | Alta | FC-154 | - |
| FC-156 | PermissionValidator | Alta | FC-154 | Valida permisos de contexto |
| FC-157 | ContextAccessService | Alta | FC-156 | Acceso controlado a contextos |
| FC-158-166 | Endpoints + Frontend | Alta | - | - |

**Nueva tabla `extension_contexts`:**
```sql
CREATE TABLE extension_contexts (
  id UUID PRIMARY KEY,
  extension_id VARCHAR(100) NOT NULL,
  
  -- Solo UNA de estas FK puede estar activa
  account_id UUID REFERENCES accounts(id),
  relationship_id UUID REFERENCES relationships(id),
  conversation_id UUID REFERENCES conversations(id),
  
  context_type VARCHAR(50) NOT NULL,
  payload JSONB NOT NULL,
  
  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  
  CHECK (
    (account_id IS NOT NULL)::int +
    (relationship_id IS NOT NULL)::int +
    (conversation_id IS NOT NULL)::int = 1
  )
);
```

**Permisos de contexto:**
```typescript
type ContextPermission =
  | 'read:context.public'
  | 'read:context.private'
  | 'read:context.relationship'
  | 'read:context.history'
  | 'read:context.overlay'
  | 'write:context.overlay';
```

---

### Hito 5: @fluxcore/fluxcore

**Objetivo:** Extensi√≥n de IA por defecto, preinstalada y habilitada.

**Duraci√≥n estimada:** 1.5 semanas

**Dependencias:** Hito 4 (Sistema de Extensiones) DEBE estar completo.

| ID | Descripci√≥n | Prioridad | Dependencias | Notas |
|----|-------------|-----------|--------------|-------|
| **FC-170** | Crear extensi√≥n `@fluxcore/fluxcore` | Alta | FC-154 | Nueva extensi√≥n en `extensions/fluxcore/` |
| **FC-171** | Definir manifest.json de fluxcore | Alta | FC-170 | Permisos: `read:context.*`, `send:messages`, etc. |
| **FC-172** | Implementar PromptBuilder | Alta | FC-170 | Combina profile + private + relationship + history |
| **FC-173** | Integrar Groq SDK | Alta | FC-172 | API key en config de extensi√≥n |
| **FC-174** | Implementar modos suggest/auto/off | Alta | FC-173 | Configurable v√≠a `extension_installations.config` |
| **FC-175** | Implementar cola de respuestas con delay | Media | FC-174 | response_delay configurable |
| **FC-176** | Pre-instalar fluxcore en nuevas cuentas | Alta | FC-171 | Hook en creaci√≥n de account |
| **FC-177** | Evento WS: `ai:suggestion` | Alta | FC-174 | Env√≠a sugerencia al frontend |
| **FC-178** | Crear componente AISuggestionCard | Alta | FC-177 | Aprobar/Editar/Descartar |
| **FC-179** | Panel de configuraci√≥n de @fluxcore/fluxcore | Media | FC-165 | En settings de extensi√≥n |

**Manifest de @fluxcore/fluxcore:**
```json
{
  "id": "@fluxcore/fluxcore",
  "name": "FluxCore AI",
  "version": "1.0.0",
  "description": "IA contextual por defecto",
  "author": "FluxCore",
  "preinstalled": true,
  "permissions": [
    "read:context.public",
    "read:context.private",
    "read:context.relationship",
    "read:context.history",
    "write:context.overlay",
    "send:messages",
    "modify:automation"
  ],
  "config_schema": {
    "enabled": { "type": "boolean", "default": true },
    "mode": { "type": "string", "enum": ["suggest", "auto", "off"], "default": "suggest" },
    "response_delay": { "type": "number", "default": 30 }
  }
}
```

---

### Hito 6: Contexto Relacional

**Duraci√≥n:** 1 semana

**Puntos clave:**
- Contexto unificado con autor√≠a por entrada
- L√≠mite 2000 chars total
- Tipos de entrada: note, preference, rule

| ID | Descripci√≥n | Prioridad | Dependencias |
|----|-------------|-----------|--------------|
| FC-130 | Extender PromptBuilder con relationship context | Alta | FC-172 |
| FC-131 | Validar l√≠mite 2000 chars total | Alta | FC-040 |
| FC-132 | Componente ContactDetailPanel | Alta | FC-060 |
| FC-133 | Componente RelationshipContextEditor (estructurado) | Alta | FC-132 |
| FC-134 | Componente TagsEditor | Media | FC-132 |
| FC-135 | Guardado optimista de context | Media | FC-133 |
| FC-136 | Selector de tipo de entrada (note/preference/rule) | Media | FC-133 |

**UI de contexto estructurado:**
```typescript
interface ContextEntry {
  author_account_id: string;
  content: string;
  type: 'note' | 'preference' | 'rule';
  created_at: string;
}

// En UI: lista de entries con chips por tipo
// [preference] "Prefiere pan integral"
// [rule] "Si cancela, ofrecer 10% descuento"
// [note] "Cliente VIP desde 2020"
```

---

### Hito 7: Extensi√≥n de Turnos

**Duraci√≥n:** 2 semanas

| ID | Descripci√≥n | Prioridad |
|----|-------------|-----------|
| FC-180-191 | Extensi√≥n appointments con tools | Alta |

---

### Hito 8: Adaptadores (WhatsApp)

**Duraci√≥n:** 2 semanas

| ID | Descripci√≥n | Prioridad |
|----|-------------|-----------|
| FC-200-210 | WhatsApp adapter | Alta |

---

### Hito 9: Workspaces Colaborativos

**Duraci√≥n:** 1.5 semanas

| ID | Descripci√≥n | Prioridad |
|----|-------------|-----------|
| FC-220-229 | Workspaces, members, roles | Alta |

---

### Hito 10: Producci√≥n Ready

**Duraci√≥n:** 2 semanas

| ID | Descripci√≥n | Prioridad |
|----|-------------|-----------|
| FC-240-255 | CI/CD, tests, docs, deploy | Alta |

---

### Hito 11: Madurez Operativa de Extensiones (NUEVO)

**Objetivo:** Sistema de extensiones robusto con ejecuci√≥n paralela, persistencia real y broadcast.

**Duraci√≥n:** 1 semana

**Aprendizaje de:** Auditor√≠a de c√≥digo INHOST (ver `AUDIT_LEARNING_REPORT.md`)

| ID | Descripci√≥n | Prioridad | Dependencias | Notas |
|----|-------------|-----------|--------------|-------|
| FC-300 | Ejecuci√≥n paralela de extensiones con timeout | Alta | Hito 4 | Promise.allSettled + timeout por extensi√≥n |
| FC-301 | Persistencia real de enrichments | Alta | FC-300 | Usar tabla message_enrichments existente |
| FC-302 | Broadcast de enrichments v√≠a WebSocket | Alta | FC-301 | Nuevo evento `enrichment:batch` |
| FC-303 | Health checks de extensiones | Media | FC-300 | Endpoint `/admin/extensions/health` |
| FC-304 | Estad√≠sticas de ExtensionHost | Media | FC-300 | Endpoint `/admin/extensions/stats` |
| FC-305 | Logger service centralizado | Media | - | Reemplazar console.log |

**Implementaci√≥n FC-300 (Ejecuci√≥n Paralela):**
```typescript
// Antes: Secuencial
for (const extension of extensions) {
  await extension.process(context);
}

// Despu√©s: Paralelo con timeout y aislamiento
const results = await Promise.allSettled(
  extensions.map(ext => this.executeWithTimeout(ext, context))
);
```

**Implementaci√≥n FC-302 (WebSocket Event):**
```typescript
// Nuevo evento WebSocket
{
  type: 'enrichment:batch',
  data: {
    conversationId: string;
    messageId: string;
    enrichments: Array<{
      id: string;
      extensionId: string;
      type: string;
      payload: any;
      confidence: number;
    }>;
    processingTimeMs: number;
  }
}
```

---

### Hito 12: Frontend de Enrichments (NUEVO)

**Objetivo:** Frontend muestra enrichments en tiempo real.

**Duraci√≥n:** 0.5 semana

| ID | Descripci√≥n | Prioridad | Dependencias | Notas |
|----|-------------|-----------|--------------|-------|
| FC-306 | Store de enrichments en Zustand | Media | FC-302 | Map<messageId, Enrichment[]> |
| FC-307 | Enrichments en IndexedDB | Baja | FC-306 | Dexie schema v2 |
| FC-308 | Handler WebSocket enrichment:batch | Media | FC-302 | - |
| FC-309 | Componente EnrichmentBadge | Media | FC-306 | UI para mostrar enrichments |

---

### Hito 13: Component Library & UI Unification ‚úÖ COMPLETADO (Audit 2026-01-14)

**Objetivo:** Establecer sistema de componentes predefinidos y eliminar HTML arbitrario.

**Duraci√≥n:** 3 semanas

**Aprendizaje de:** Auditor√≠a de UI (ver `docs/UI_AUDIT_REPORT.md`)

| ID | Descripci√≥n | Prioridad | Estado | Evidencia |
|----|-------------|-----------|--------|-----------|
| **FC-400** | Migrar ExtensionsPanel al sistema can√≥nico | Alta | ‚úÖ | Verificado - 0 colores hardcodeados |
| **FC-401** | Prevenir duplicaci√≥n de tabs de chat | Alta | ‚úÖ | L√≥gica implementada en Sidebar.tsx:131-153 |
| **FC-402** | Corregir flujo de navegaci√≥n de Settings | Alta | ‚úÖ | Flujo correcto verificado |
| **FC-403** | Hacer tab de Settings closable | Alta | ‚úÖ | Tab es closable |
| **FC-404** | Crear Button component | Alta | ‚úÖ | `ui/Button.tsx` con 4 variantes |
| **FC-405** | Crear Input component | Alta | ‚úÖ | `ui/Input.tsx` con iconos |
| **FC-406** | Crear Card component | Alta | ‚úÖ | `ui/Card.tsx` implementado |
| **FC-407** | Crear Badge component | Alta | ‚úÖ | `ui/Badge.tsx` con 4 variantes |
| **FC-408** | Crear Table component | Media | ‚úÖ | `ui/Table.tsx` con sorting |
| **FC-409** | Crear Select component | Media | ‚úÖ | `ui/Select.tsx` implementado |
| **FC-410** | Crear Checkbox component | Media | ‚úÖ | `ui/Checkbox.tsx` implementado |
| **FC-411** | Crear Avatar component | Media | ‚úÖ | `ui/Avatar.tsx` con fallback |
| **FC-412** | Crear SidebarLayout unificado | Media | ‚úÖ | `ui/SidebarLayout.tsx` implementado |
| **FC-413** | Eliminar bot√≥n X de Sidebar | Media | ‚úÖ | L√≥gica de pin implementada |
| **FC-414** | Refactorizar tabs para usar componentes | Media | ‚úÖ | Tabs usan componentes UI |
| **FC-415** | Hacer ActivityBar header responsive | Baja | ‚úÖ | Responsive implementado |
| **FC-416** | Documentar Component Library | Alta | ‚úÖ | `ui/index.ts` con barrel exports |
| **FC-417** | Crear gu√≠a de dise√±o para extensiones | Alta | üü° | Pendiente documentaci√≥n formal |

**Resultado:** ‚úÖ **16/17 tareas completadas** (94%)
- Component Library 100% funcional
- Sistema de dise√±o can√≥nico aplicado consistentemente
- 0 colores hardcodeados detectados en audit

**Implementaci√≥n FC-404 (Button):**
```tsx
interface ButtonProps {
  variant?: 'primary' | 'secondary' | 'ghost' | 'danger';
  size?: 'sm' | 'md' | 'lg';
  icon?: React.ReactNode;
  loading?: boolean;
  disabled?: boolean;
  children: React.ReactNode;
  onClick?: () => void;
}

// Variantes con clases can√≥nicas
const variants = {
  primary: 'bg-accent text-inverse hover:bg-accent-hover',
  secondary: 'bg-elevated text-primary border border-default hover:bg-hover',
  ghost: 'bg-transparent text-secondary hover:text-primary hover:bg-hover',
  danger: 'bg-error text-inverse hover:bg-error-hover'
};
```

**Implementaci√≥n FC-412 (SidebarLayout):**
```tsx
interface SidebarLayoutProps {
  header: React.ReactNode;
  search?: React.ReactNode;
  actions?: React.ReactNode;
  tabs?: React.ReactNode;
  content: React.ReactNode;
  footer?: React.ReactNode;
}

// Estructura est√°ndar para todos los sidebars
<div className="flex flex-col h-full bg-surface">
  <div className="px-4 py-3 border-b border-subtle">{header}</div>
  {search && <div className="px-4 py-3">{search}</div>}
  {actions && <div className="px-4 pb-3">{actions}</div>}
  {tabs && <div className="px-4 pb-3">{tabs}</div>}
  <div className="flex-1 overflow-y-auto">{content}</div>
  {footer && <div className="px-4 py-3 border-t border-subtle">{footer}</div>}
</div>
```

---

## Hito 14: Testing E2E & Production Hardening (Semana 23)

**Objetivo:** Garantizar calidad de producci√≥n con tests automatizados end-to-end.

**Duraci√≥n estimada:** 1 semana

### Tareas

| ID | Tarea | Prioridad | Dependencia | Descripci√≥n |
|----|-------|-----------|-------------|-------------|
| **FC-500** | Configurar Playwright | Alta | - | Setup inicial para tests E2E |
| **FC-501** | Test E2E: Autenticaci√≥n | Alta | FC-500 | Login, Register, Logout |
| **FC-502** | Test E2E: Chat | Alta | FC-501 | Enviar mensajes, ver conversaciones |
| **FC-503** | Test E2E: Settings | Media | FC-501 | Cambio de tema, configuraci√≥n |
| **FC-504** | Test E2E: Extensions | Media | FC-501 | Listar, instalar, configurar |
| **FC-505** | Integrar E2E en CI/CD | Alta | FC-501-504 | GitHub Actions con Playwright |
| **FC-506** | Documentar deployment | Media | - | Gu√≠a completa de producci√≥n |

---

## Hito 15: Performance Optimization (Semana 24)

**Objetivo:** Optimizar rendimiento del frontend reduciendo tama√±o de bundle y mejorando tiempo de carga.

**Duraci√≥n estimada:** 0.5 semanas

### Tareas

| ID | Tarea | Prioridad | Descripci√≥n |
|----|-------|-----------|-------------|
| **FC-600** | Code Splitting con React.lazy | Alta | Lazy loading de rutas y componentes pesados |
| **FC-601** | Optimizar imports | Alta | Tree shaking de lucide-react y dependencias |
| **FC-602** | Bundle Analysis | Media | Configurar visualizador de bundle |
| **FC-603** | Image Optimization | Baja | Lazy loading de im√°genes |
| **FC-604** | Preload cr√≠ticos | Media | Prefetch de chunks esenciales |

---

### Hito 16: Profile System ‚úÖ COMPLETADO (2024-12-09)

**Objetivo:** Sistema completo de perfil de usuario para la prueba de producci√≥n.

**Duraci√≥n estimada:** 1 semana

**Referencia:** `docs/archive/AUDIT_PRODUCTION_TEST.md`

### Tareas

| ID | Tarea | Prioridad | Descripci√≥n |
|----|-------|-----------|-------------|
| **FC-800** | ProfileSection completa | Alta | Reemplaza "Pr√≥ximamente" con UI funcional |
| **FC-801** | Bio (presentaci√≥n) | Alta | Campo 0/150 chars con placeholder (inline en ProfileSection) |
| **FC-802** | AvatarUpload | Alta | Upload de foto de perfil |

**Criterios de aceptaci√≥n:**
- [x] Usuario puede editar foto de perfil
- [x] Usuario puede escribir presentaci√≥n (0/150 chars)
- [x] Usuario puede editar nombre visible
- [x] Usuario puede escribir contexto IA (0/5000 chars)
- [x] Editor expandible funciona en nueva tab
- [x] Toggle de cuenta de negocio visible

**Evidencia m√≠nima (c√≥digo/API):**
- `apps/web/src/components/settings/ProfileSection.tsx` (bio 0/150, displayName, privateContext 0/5000, trigger editor expandible)
- `apps/web/src/hooks/useProfile.ts` (CRUD perfil v√≠a API + recarga por `selectedAccountId`)
- `apps/web/src/components/profile/AvatarUpload.tsx` (upload avatar por cuenta)
- `apps/web/src/components/editors/ExpandedEditor.tsx` + `apps/web/src/components/panels/DynamicContainer.tsx` (tab `editor`)
- `apps/api/src/routes/upload.routes.ts` (`POST /upload/avatar?accountId=...`)
- `apps/api/src/server.ts` (serve est√°tico `/uploads/*`)

**Evidencia m√≠nima (PostgreSQL):**
- `accounts.profile` (JSONB: `bio`, `avatarUrl`)
- `accounts.private_context`

---

## Hito 17: Account Management ‚úÖ COMPLETADO (2024-12-09)

**Objetivo:** Gesti√≥n de cuentas personales y de negocio.

**Duraci√≥n estimada:** 1 semana

### Tareas

| ID | Tarea | Prioridad | Descripci√≥n |
|----|-------|-----------|-------------|
| **FC-810** | AccountStore | Alta | Store Zustand para cuentas |
| **FC-811** | AccountSwitcher | Alta | Selector en header (avatar superior izq) |
| **FC-812** | AccountsSection | Alta | Secci√≥n en Settings |
| **FC-813** | ConvertToBusiness | Alta | UI para convertir cuenta a negocio |
| **FC-814** | CreateBusinessAccount | Alta | UI para crear cuenta de negocio |
| **FC-815** | Hook useAccounts | Alta | CRUD de cuentas conectado a API |
| **FC-816** | API client accounts | Alta | `services/accounts.ts` |

**Criterios de aceptaci√≥n:**
- [x] Usuario puede ver sus cuentas (personal/negocio)
- [x] Usuario puede convertir cuenta a negocio
- [x] Usuario puede crear cuenta de negocio nueva
- [x] Selector de cuenta visible en header/ActivityBar
- [x] Cambio de cuenta funciona correctamente

**Evidencia m√≠nima (c√≥digo/API):**
- `apps/web/src/store/accountStore.ts` (FC-810/811/816)
- `apps/web/src/components/accounts/AccountSwitcher.tsx` (FC-811)
- `apps/web/src/components/accounts/AccountsSection.tsx` (FC-812/813/814)
- `apps/web/src/services/accounts.ts` + `apps/web/src/services/api.ts` (FC-816)
- `apps/api/src/routes/accounts.routes.ts` (`GET /accounts`, `POST /accounts`, `POST /accounts/:id/convert-to-business`)
- `apps/api/src/services/account.service.ts`
- IndexedDB por-cuenta: `apps/web/src/db/index.ts` + `apps/web/src/hooks/useContextRefresh.ts`

---

## Hito 18: Workspace & Collaborators UI üü° PARCIAL (Audit 2026-01-14)

**Objetivo:** Frontend completo para workspaces colaborativos.

**Duraci√≥n estimada:** 1.5 semanas

### Tareas

| ID | Tarea | Prioridad | Descripci√≥n | Estado |
|----|-------|-----------|-------------|--------|
| **FC-820** | Hook useWorkspaces | Alta | CRUD de workspaces | ‚úÖ |
| **FC-821** | WorkspaceStore | Alta | Store Zustand | ‚úÖ |
| **FC-822** | CollaboratorsList | Alta | Lista de miembros del workspace | ‚úÖ |
| **FC-823** | UserSearch | Alta | B√∫squeda de usuarios por alias | ‚úÖ |
| **FC-824** | InviteCollaborator | Alta | Modal/form para invitar | üü° |
| **FC-825** | PermissionsSelector | Media | Selector de permisos por m√≥dulo | ‚úÖ |
| **FC-826** | Hook useInvitations | Alta | Gesti√≥n de invitaciones | ‚úÖ |
| **FC-827** | InvitationsList | Alta | Lista de invitaciones pendientes | ‚úÖ |
| **FC-828** | AcceptInvitation | Alta | UI para aceptar invitaci√≥n | ‚úÖ |
| **FC-829** | PendingInvitations | Alta | Indicador en header | ‚úÖ |
| **FC-830** | API client workspaces | Alta | `services/workspaces.ts` | ‚úÖ |

**Criterios de aceptaci√≥n:**
- [x] Usuario puede ver lista de colaboradores
- [x] Usuario puede buscar usuarios por alias
- [x] Usuario puede invitar por email
- [x] Usuario puede asignar permisos espec√≠ficos
- [x] Invitado puede ver y aceptar invitaci√≥n
- [ ] Invitado ve workspace seg√∫n sus permisos (pendiente verificaci√≥n)

**Issue detectado (ISSUE-FC-01):**
- **Severidad:** Media
- **Archivo:** `apps/web/src/components/workspace/InviteCollaborator.tsx:82`
- **Descripci√≥n:** Placeholder email `${username}@fluxcore.local` en lugar del email real
- **Soluci√≥n:** Agregar campo `email` a tabla `accounts` o usar `users.email` en b√∫squeda de usuarios

**Evidencia m√≠nima (c√≥digo/API/DB):**
- Frontend:
  - `apps/web/src/store/workspaceStore.ts` (FC-820/821/826)
  - `apps/web/src/components/workspace/CollaboratorsList.tsx` (FC-822/825)
  - `apps/web/src/components/workspace/InviteCollaborator.tsx` (FC-823/824)
  - `apps/web/src/components/workspace/InvitationsList.tsx` (FC-827/828/829)
  - `apps/web/src/services/workspaces.ts` (FC-830)
- Backend:
  - `apps/api/src/routes/workspaces.routes.ts` (CRUD workspaces + miembros + invitaciones)
  - `apps/api/src/services/workspace.service.ts`
- PostgreSQL:
  - `workspaces`, `workspace_members`, `workspace_invitations`

---

## Hito 19: Welcome Experience üü° PARCIAL (Audit 2026-01-14)

**Objetivo:** Experiencia de bienvenida para nuevos usuarios.

**Duraci√≥n estimada:** 0.5 semanas

### Tareas

| ID | Tarea | Prioridad | Descripci√≥n | Estado |
|----|-------|-----------|-------------|--------|
| **FC-840** | WelcomeMessage | Alta | Mensaje inicial de FluxCore | ‚úÖ |
| **FC-841** | FluxCoreAvatar | Media | Avatar distintivo de FluxCore | ‚úÖ |
| **FC-842** | OnboardingConversation | Alta | Crear conversaci√≥n inicial (backend) | ‚è≥ |
| **FC-843** | FirstTimeExperience | Media | Detectar primer login | ‚úÖ |

**Criterios de aceptaci√≥n:**
- [ ] Usuario nuevo ve mensaje de bienvenida de FluxCore (componente existe, falta activaci√≥n)
- [ ] Conversaci√≥n inicial creada autom√°ticamente (pendiente implementaci√≥n backend)
- [x] Avatar de FluxCore distintivo (implementado)

**Issue detectado (ISSUE-FC-03):**
- **Severidad:** Baja
- **Archivo:** `apps/api/src/services/auth.service.ts`
- **Descripci√≥n:** No se crea conversaci√≥n de bienvenida autom√°ticamente al registrar usuario
- **Soluci√≥n:** Llamar a `extensionHost.tryCreateWelcomeConversation` en el flujo de registro
- **Impacto:** Usuarios nuevos no ven mensaje de bienvenida de FluxCore

**Evidencia m√≠nima (c√≥digo):**
- `apps/web/src/components/chat/WelcomeView.tsx` - Vista vac√≠a con FluxCoreAvatar
- `apps/web/src/components/onboarding/WelcomeMessage.tsx` (FC-840/841/843: componentes/hook)

---

## Hito 20: PWA Support üü° PARCIAL (Audit 2026-01-14)

**Objetivo:** Convertir FluxCore en Progressive Web App instalable.

**Duraci√≥n estimada:** 0.5 semanas

### Tareas

| ID | Tarea | Prioridad | Descripci√≥n | Estado |
|----|-------|-----------|-------------|--------|
| **FC-900** | Configurar vite-plugin-pwa | Alta | Service worker y manifest | ‚úÖ |
| **FC-901** | Crear manifest.json | Alta | Iconos, colores, nombre | ‚úÖ |
| **FC-902** | Configurar caching strategy | Alta | Cache-first para assets | ‚úÖ |
| **FC-903** | Crear offline fallback | Media | P√°gina offline b√°sica | ‚è≥ |
| **FC-904** | Agregar install prompt | Baja | UI para instalar app | ‚è≥ |

**Estado real (evidencia):**
- ‚úÖ `apps/web/vite.config.ts`: `vite-plugin-pwa` configurado (manifest + workbox)
- ‚úÖ `apps/web/public/manifest.json`: Configurado con metadata correcta
- ‚ö†Ô∏è **Assets faltantes:** `pwa-192x192.png`, `pwa-512x512.png`, `favicon.ico`, `apple-touch-icon.png`, `mask-icon.svg`
- ‚ö†Ô∏è Offline fallback UI no implementada
- ‚ö†Ô∏è Install prompt UI no implementada

**Assets existentes:**
- ‚úÖ `apps/web/public/pwa-192x192.svg` (fuente para generar PNGs)

**Soluci√≥n requerida:**
1. Generar iconos PNG desde SVG existente (192x192, 512x512)
2. Crear favicon.ico multi-resoluci√≥n
3. Generar apple-touch-icon.png (180x180)
4. Crear mask-icon.svg para Safari
5. Implementar p√°gina offline b√°sica
6. Agregar UI de install prompt (opcional)

---

## Cronograma de Ejecuci√≥n

```
Semana 1:     Hito 0 - Bootstrap
Semana 2-3:   Hito 1 - Identidad
Semana 4-5:   Hito 2 - Chat Core
Semana 6-7:   Hito 3 - Workspace UI
Semana 8-9:   Hito 4 - Sistema de Extensiones
Semana 10:    Hito 5 - @fluxcore/fluxcore
Semana 11:    Hito 6 - Contexto Relacional
Semana 12-13: Hito 7 - Extensi√≥n Turnos
Semana 14-15: Hito 8 - WhatsApp Adapter
Semana 16:    Hito 9 - Workspaces Backend
Semana 17-18: Hito 10 - Producci√≥n Ready
Semana 19:    Hito 11 - Madurez Operativa Extensiones
Semana 19.5:  Hito 12 - Frontend Enrichments
Semana 20-22: Hito 13 - Component Library & UI Unification
Semana 23:    Hito 14 - Testing E2E & Production Hardening
Semana 24:    Hito 15 - Performance Optimization
Semana 25:    Hito 16 - Profile System (CR√çTICO)
Semana 26:    Hito 17 - Account Management (CR√çTICO)
Semana 27-28: Hito 18 - Workspace & Collaborators UI (CR√çTICO)
Semana 28.5:  Hito 19 - Welcome Experience
Semana 29:    üéØ PRUEBA DE PRODUCCI√ìN (Carlos, Mar√≠a, Daniel)
Semana 30:    Hito 20 - PWA Support

Total: ~30 semanas
```

---

## Decisiones Arquitect√≥nicas Clave

### IA como Extensi√≥n

**Decisi√≥n:** La IA NO es parte del n√∫cleo. Es una extensi√≥n preinstalada (`@fluxcore/fluxcore`).

**Justificaci√≥n:**
- N√∫cleo m√°s simple y estable
- IA puede actualizarse independientemente
- Modelo de negocio: fluxcore gratis, extensiones IA premium monetizan v√≠a Credits
- Permite reemplazar/deshabilitar IA completamente

**Impacto:** MessageCore no tiene dependencia a IA, solo delega a extensiones.

### Credits Platform (Monetizaci√≥n)

**Decisi√≥n:** FluxCore implementa una plataforma de Credits independiente, scoped por **account**, consumida por features (IA/tools/extensiones) como **consumers**.

**Justificaci√≥n:**
- Permite pricing flexible (promos, bundles, rewards) sin acoplarlo a una extensi√≥n espec√≠fica.
- Permite monetizar por feature (p. ej. sesi√≥n IA 24h por conversaci√≥n, tool calls, instalaci√≥n de extensiones).
- Mantiene `@fluxcore/fluxcore` como base gratuita y habilita premium por consumo controlado.

**Impacto:** Se agrega wallet + ledger + policies; los m√≥dulos premium consultan/reservan/capturan cr√©ditos v√≠a un servicio central.

### Context Overlays

**Decisi√≥n:** Las extensiones tienen su propio espacio de contexto (`extension_contexts`).

**Justificaci√≥n:**
- Extensiones no modifican datos del n√∫cleo
- Aislamiento entre extensiones
- Permisos granulares de lectura

**Impacto:** Nueva tabla, nuevos permisos.

### Contexto Relacional Unificado

**Decisi√≥n:** Un solo `context` JSONB con entries estructurados, no dos campos direccionales.

**Justificaci√≥n:**
- Evita redundancia con historial de mensajes
- M√°s flexible: permite tipos (note, preference, rule)
- Mantiene autor√≠a por entrada

**Impacto:** Schema de relationships cambia.

### Component Library como Fuente √önica de UI

**Decisi√≥n:** Todas las extensiones DEBEN usar componentes predefinidos de la Component Library. HTML arbitrario est√° prohibido.

**Justificaci√≥n:**
- Garantiza unicidad visual del sistema
- Facilita mantenimiento y actualizaciones
- Previene inconsistencias de dise√±o
- Simplifica desarrollo de extensiones de terceros
- Permite evoluci√≥n del dise√±o sin romper extensiones

**Impacto:**
- Nuevos componentes en `apps/web/src/components/ui/`
- Manifest de extensiones debe declarar componentes permitidos
- Validaci√≥n en ExtensionHost de componentes usados
- Documentaci√≥n exhaustiva para desarrolladores

**Reglas de Enforcement:**
```typescript
// En manifest.json de extensi√≥n
{
  "ui": {
    "allowedComponents": ["Button", "Input", "Card", "Badge"],
    "customCSS": false  // Prohibido
  }
}

// ExtensionHost valida que solo use componentes permitidos
```

---

## Riesgos

| Riesgo | Probabilidad | Impacto | Mitigaci√≥n |
|--------|--------------|---------|------------|
| Extensi√≥n fluxcore falla | Media | Alto | Fallback: n√∫cleo funciona sin IA |
| Permisos de contexto complejos | Media | Medio | UI clara de permisos en manifest |
| Crecimiento de overlays | Alta | Medio | L√≠mites por plan, cleanup policies |
| Complejidad de extensiones | Media | Medio | SDK bien documentado, ejemplos |
| **Ejecuci√≥n paralela causa race conditions** | Baja | Medio | Promise.allSettled a√≠sla fallos, no comparten estado |
| **Persistencia enrichments falla** | Baja | Alto | Transacciones DB, retry logic |
| **WebSocket broadcast sobrecarga** | Baja | Bajo | Throttling si necesario |
| **Component Library limita creatividad de extensiones** | Media | Medio | Componentes flexibles con props, feedback de comunidad |
| **Extensiones existentes rompen con Component Library** | Alta | Alto | Migraci√≥n gradual, deprecation warnings, gu√≠as de migraci√≥n |
| **Mantenimiento de Component Library complejo** | Media | Medio | Versionado sem√°ntico, changelog detallado, tests exhaustivos |
| **Migraci√≥n a httpOnly cookies rompe flujo existente** | Media | Alto | Feature flag, migraci√≥n gradual, fallback a localStorage |
| **Rate limiting bloquea usuarios leg√≠timos** | Baja | Medio | Configuraci√≥n por tier, whitelist de IPs conocidas |
| **Virtualizaci√≥n afecta accesibilidad** | Baja | Medio | Testing con screen readers, fallback para listas cortas |
| **Circuit breaker abierto demasiado tiempo** | Baja | Medio | Alertas en half-open, health checks frecuentes |

---

## An√°lisis de Impacto de Nuevos Hitos

### Impacto en Base de Datos

| Issue | Tabla Afectada | Tipo de Cambio |
|-------|---------------|----------------|
| FC-301 | `message_enrichments` | INSERT (ya existe) |
| FC-307 | IndexedDB `enrichments` | Nueva tabla (Dexie v2) |

**No requiere migraciones PostgreSQL** - la tabla `message_enrichments` ya existe.

### Impacto en APIs

| Issue | Endpoint | Tipo |
|-------|----------|------|
| FC-302 | WebSocket `enrichment:batch` | Evento nuevo |
| FC-303 | `GET /admin/extensions/health` | Endpoint nuevo |
| FC-304 | `GET /admin/extensions/stats` | Endpoint nuevo |

**Todos son adiciones**, no modificaciones de APIs existentes.

### Impacto en Frontend

| Issue | Componente/Store | Tipo |
|-------|------------------|------|
| FC-306 | `enrichmentsStore.ts` | Store nuevo |
| FC-308 | WebSocket handler | Handler nuevo |
| FC-309 | `EnrichmentBadge.tsx` | Componente nuevo |

**Sin breaking changes** en componentes existentes

### Impacto del Hito 13 (Component Library)

#### Base de Datos
**Ninguno** - Todos los cambios son de UI/Frontend

#### APIs
**Ninguno** - No se modifican endpoints

#### Stores
| Store | Cambio | Tipo |
|-------|--------|------|
| `panelStore.ts` | Agregar `findTabByContext()` | M√©todo nuevo |
| `uiStore.ts` | Modificar l√≥gica de pin en `setActiveActivity()` | Modificaci√≥n |

#### Componentes
| Componente | Tipo de Cambio | Breaking |
|------------|----------------|----------|
| ExtensionsPanel | Refactor colores | No |
| ExtensionCard | Refactor colores | No |
| ExtensionConfigPanel | Refactor colores | No |
| ViewPort | L√≥gica de tabs | No |
| Sidebar | Eliminar bot√≥n X | S√≠ (menor) |
| ActivityBar | L√≥gica de pin | No |
| ConversationsList | Usar SidebarLayout | S√≠ (refactor) |
| ContactsList | Usar SidebarLayout | S√≠ (refactor) |
| SettingsPanel | Usar SidebarLayout | S√≠ (refactor) |
| DynamicContainer | Usar componentes predefinidos | S√≠ (refactor) |

#### Nuevos Componentes
- `apps/web/src/components/ui/Button.tsx`
- `apps/web/src/components/ui/Input.tsx`
- `apps/web/src/components/ui/Card.tsx`
- `apps/web/src/components/ui/Badge.tsx`
- `apps/web/src/components/ui/Table.tsx`
- `apps/web/src/components/ui/Select.tsx`
- `apps/web/src/components/ui/Checkbox.tsx`
- `apps/web/src/components/ui/Avatar.tsx`
- `apps/web/src/components/layout/SidebarLayout.tsx`
- `apps/web/src/components/layout/SidebarHeader.tsx`
- `apps/web/src/components/layout/SidebarSearch.tsx`
- `apps/web/src/components/layout/SidebarActions.tsx`

#### Documentaci√≥n
- `docs/COMPONENT_LIBRARY.md` - Gu√≠a de componentes
- `docs/EXTENSION_DESIGN_GUIDE.md` - Gu√≠a de dise√±o para extensiones

---

### Hito 24: Emparejamiento Frontend-Backend (COMPLETADO 2024-12-09)

**Duraci√≥n:** 4 horas
**Estado:** ‚úÖ COMPLETADO

| ID | Descripci√≥n | Estado | Archivos |
|----|-------------|--------|----------|
| EMF-001 | Conectar b√∫squeda contactos a API | ‚úÖ | `api.ts`, `ContactsList.tsx` |
| EMF-002 | Modal agregar contacto funcional | ‚úÖ | `ContactsList.tsx` |
| EMF-003 | Endpoint convert-to-business | ‚úÖ | `accounts.routes.ts`, `account.service.ts` |
| EMF-004 | Frontend usa endpoint real | ‚úÖ | `accounts.ts`, `api.ts` |

**Endpoints Agregados:**
- `GET /accounts/search?q=` - B√∫squeda de usuarios
- `POST /accounts/:id/convert-to-business` - Conversi√≥n a cuenta de negocio

---

### Hito 25: Arquitectura Settings Can√≥nica (COMPLETADO 2024-12-09)

**Duraci√≥n:** 2 horas
**Estado:** ‚úÖ COMPLETADO

| ID | Descripci√≥n | Estado | Archivos |
|----|-------------|--------|----------|
| SET-001 | SettingsMenu en Sidebar (solo men√∫) | ‚úÖ | `SettingsMenu.tsx` |
| SET-002 | Settings abre tabs en DynamicContainer | ‚úÖ | `DynamicContainer.tsx` |
| SET-003 | ProfileSection como tab | ‚úÖ | `DynamicContainer.tsx` |
| SET-004 | AccountsSection como tab | ‚úÖ | `DynamicContainer.tsx` |

**Arquitectura Can√≥nica:**
```
ActivityBar ‚Üí Sidebar (Men√∫) ‚Üí DynamicContainer (Contenido)
```

---

### Hito 26: Estabilizaci√≥n Core (COMPLETADO 2024-12-09)

**Duraci√≥n:** 2 horas
**Estado:** ‚úÖ COMPLETADO

| ID | Tarea | Prioridad | Archivos Modificados |
|----|-------|-----------|---------------------|
| STB-001 | WebSocket loop infinito | ‚úÖ | `useWebSocket.ts` - Max 5 intentos, backoff exponencial |
| STB-002 | API calls redundantes | ‚úÖ | `useProfile.ts`, `ContactsList.tsx` - hasLoaded flags |
| FIX-001 | Crear account al registrar | ‚úÖ | `auth.service.ts` - Auto-create personal account |
| FIX-002 | Scroll en contenedores | ‚úÖ | `DynamicContainer.tsx` - overflow-auto |

**Causa ra√≠z identificada:** El registro de usuarios NO creaba una cuenta asociada, causando "No se encontraron cuentas".

---

### Hito PC-4: Avatar Upload Connection Issue üî¥ CR√çTICO (Detectado 2025-12-10)

**Objetivo:** Resolver error de conexi√≥n al subir im√°genes de perfil.

**Duraci√≥n estimada:** 0.2 d√≠as

**Prioridad:** Alta (bloqueante para UX de perfil)

**Problema Detectado:** 
- Usuario recibe "No se puede conectar al servidor. Verifica que el backend est√© corriendo."
- Backend est√° corriendo en puerto 3000
- Endpoint `/upload/avatar` est√° registrado en server.ts
- Directorio `uploads/avatars` existe

| ID | Tarea | Prioridad | Descripci√≥n | Estado |
|----|-------|-----------|-------------|--------|
| **PC-130** | Verificar CORS en endpoint upload | Alta | Configurar headers CORS para multipart/form-data | ‚è≥ Pendiente |
| **PC-131** | Debug request headers | Alta | Loggear headers y body en upload.routes.ts | ‚è≥ Pendiente |
| **PC-132** | Test endpoint manualmente | Alta | curl/Postman para verificar `/upload/avatar` | ‚è≥ Pendiente |
| **PC-133** | Verificar auth middleware | Alta | Confirmar que token se env√≠a correctamente | ‚è≥ Pendiente |
| **PC-134** | Mejor mensaje de error | Media | Detallar espec√≠ficamente qu√© fall√≥ | ‚è≥ Pendiente |

**Criterios de √©xito:**
- [ ] Endpoint `/upload/avatar` responde correctamente
- [ ] Im√°genes se suben y guardan en filesystem
- [ ] URL se retorna y persiste en account.avatarUrl
- [ ] Mensajes de error espec√≠ficos y √∫tiles

**Plan de verificaci√≥n:**
1. Test manual del endpoint con curl
2. Verificar logs del backend durante upload
3. Confirmar CORS headers para multipart
4. Probar flujo completo en UI

---

## Hitos de Pendientes por Corregir (Generados 2024-12-10)

### Hito PC-1: Avatar Upload System ‚úÖ COMPLETADO (2024-12-10)

**Objetivo:** Implementar sistema completo de subida de fotos de perfil.

**Duraci√≥n estimada:** 0.5 semanas

**Prioridad:** Alta (bloqueante para UX completa)

| ID | Tarea | Prioridad | Descripci√≥n |
|----|-------|-----------|-------------|
| **PC-100** | Endpoint POST /upload/avatar | Alta | ‚úÖ Recibir imagen, validar, guardar |
| **PC-101** | Storage service | Alta | ‚úÖ Guardar en filesystem |
| **PC-102** | Actualizar profile.avatarUrl | Alta | ‚úÖ PATCH account con URL de imagen |
| **PC-103** | AvatarUpload component | Alta | ‚úÖ Input file + preview + upload |
| **PC-104** | Integrar en ProfileSection | Alta | ‚úÖ Reemplazar placeholder |

**Criterios de √©xito:**
- [x] Usuario puede seleccionar imagen desde dispositivo
- [x] Preview de imagen antes de subir
- [x] Imagen se guarda en servidor
- [x] URL se persiste en account.profile.avatarUrl
- [x] Avatar se muestra en UI

---

### Hito PC-2: Password Reset Flow ‚úÖ COMPLETADO (2024-12-10)

**Objetivo:** Completar flujo de recuperaci√≥n de contrase√±a.

**Duraci√≥n estimada:** 0.5 semanas

**Prioridad:** Media

| ID | Tarea | Prioridad | Descripci√≥n |
|----|-------|-----------|-------------|
| **PC-110** | Tabla password_reset_tokens | Alta | Schema para tokens de reset |
| **PC-111** | Persistir tokens en DB | Alta | Reemplazar console.log |
| **PC-112** | Endpoint POST /auth/reset-password | Alta | Validar token, cambiar password |
| **PC-113** | Email service | Media | Mock en dev (logs console) |
| **PC-114** | ResetPasswordPage | Alta | UI para nueva contrase√±a |

**Criterios de √©xito:**
- [x] Token se guarda en DB con expiraci√≥n
- [x] Email se env√≠a con link de reset (mocked)
- [x] Usuario puede cambiar contrase√±a con token v√°lido
- [x] Token expira despu√©s de uso

---

### Hito PC-3: Automation Triggers Avanzados ‚è≥ EN PROGRESO (Revisi√≥n 2025-12-10)

**Objetivo:** Completar soporte avanzado de triggers (schedule + webhook) para automatizaciones, garantizando cron jobs confiables y endpoints externos seguros.

**Duraci√≥n estimada:** 1 semana

**Prioridad:** Media (requerido para flujos de automatizaci√≥n en producci√≥n)

| ID | Tarea | Prioridad | Descripci√≥n | Estado |
|----|-------|-----------|-------------|--------|
| **PC-120** | Schedule trigger | Alta | Persistencia y ejecuci√≥n con Croner, soporte timezone | ‚è≥ Pendiente |
| **PC-121** | Webhook trigger | Alta | Ingesta segura de webhooks externos con tokens y validaciones | ‚è≥ Pendiente |
| **PC-122** | Trigger UI | Media | Configurar triggers en frontend | ‚è≥ Pendiente |

**Deliverables t√©cnicos:**
- Registro de triggers schedule y webhook desde API (`automationController.registerTrigger`).
- Scheduler que refresca cron jobs por cuenta (`automation-scheduler.service`).
- Endpoint p√∫blico para webhooks con validaciones y logging.
- UI de configuraci√≥n en Settings ‚Üí Automation.

**Criterios de √©xito:**
- [ ] Reglas ejecutan workflows en horarios programados con timezone configurable.
- [ ] Webhooks externos pueden disparar reglas.

---

### Hito PC-4: UI Completeness

**Objetivo:** Completar vistas pendientes en DynamicContainer.

**Duraci√≥n estimada:** 0.5 semanas

**Prioridad:** Media

| ID | Tarea | Prioridad | Descripci√≥n |
|----|-------|-----------|-------------|
| **PC-130** | ContactDetailView | Media | Vista detallada de contacto |
| **PC-131** | ExtensionView | Media | Cargar UI de extensi√≥n |
| **PC-132** | CloseContainerDialog | Baja | Di√°logo "No puedes cerrar √∫ltimo container" |
| **PC-133** | Migrar legacy CSS | Baja | Eliminar clases .bg-theme-* |

**Criterios de √©xito:**
- [ ] Click en contacto muestra vista detallada
- [ ] Extensiones pueden renderizar su UI
- [ ] Usuario recibe feedback al intentar cerrar √∫ltimo container

---

### Hito PC-5: Correcci√≥n UI Chat

**Duraci√≥n:** 3 d√≠as  
**Dependencias:** Hito 2 (Chat Core), Hito 13 (Component Library)  
**Riesgos:** WebSocket (1), Mobile (2), Estado conversaciones (3)

| ID | Descripci√≥n | Prioridad | Componentes | Notas |
|----|-------------|-----------|-------------|-------|
| FC-850 | Fix input position + auto-scroll | Alta | ChatView.tsx | Usar clases can√≥nicas |
| FC-851 | Alineaci√≥n mensajes (message-in/out) | Alta | MessageList.tsx | Validar en iOS/Android |
| FC-852 | Nombres de tabs truncados + tooltips | Media | TabBar.tsx | ‚úâÔ∏è + 5 chars |

**Criterios √âxito:**  
- ‚úÖ 100% mensajes alineados correctamente  
- ‚úÖ Scroll autom√°tico <100ms (P95)  
- ‚úÖ 0 regresiones funcionalidad WebSocket  
- ‚úÖ 100% cobertura tests en componentes modificados

**Impacto DB/API:**  
- Ninguno (cambios solo frontend)

---

### Hito PC-6: AI Feedback & Refinement System

**Objetivo:** Implementar sistema de feedback y refinaci√≥n para mensajes generados por IA, permitiendo a usuarios evaluar y mejorar respuestas autom√°ticas.

**Duraci√≥n estimada:** 1 semana  
**Prioridad:** üî¥ Alta (Core del wireframe)  
**Dependencias:** Hito 2 (Chat Core), Hito 5 (Automation Core)  
**Wireframes:** 13 archivos SVG en `apps/web/src/components/Dise√±o de chat/` (feedback üëçüëé + refinaci√≥n)  
**Docs:** `CHAT_WIREFRAME_INVENTORY.md`, `CHAT_WIREFRAME_AUDIT_SUMMARY.md`, `CHAT_BACKEND_FRONTEND_MAPPING.md`  
**Referencia:** Gaps G-15, G-16 en `CHAT_BACKEND_FRONTEND_MAPPING.md`

| ID | Tarea | Prioridad | Componentes | Estimaci√≥n |
|----|-------|-----------|-------------|------------|
| **FC-1100** | Schema: tabla `ai_feedback` | Alta | packages/db | 1h |
| **FC-1101** | Schema: campos `refined_from`, `refinement_observation` en messages | Alta | packages/db | 30min |
| **FC-1102** | Endpoint `POST /messages/:id/feedback` | Alta | apps/api/routes | 2h |
| **FC-1103** | Endpoint `POST /messages/:id/refine` | Alta | apps/api/routes | 4h |
| **FC-1104** | Service: AIFeedbackService | Alta | apps/api/services | 3h |
| **FC-1105** | Service: MessageRefinementService con LLM | Alta | apps/api/services | 6h |
| **FC-1106** | Frontend: MessageHoverMenu con üëçüëé para IA | Alta | apps/web/components | 3h |
| **FC-1107** | Frontend: AIRefinementPanel | Alta | apps/web/components | 4h |
| **FC-1108** | Hook: useAIFeedback | Media | apps/web/hooks | 2h |
| **FC-1109** | Tests E2E: feedback y refinaci√≥n | Media | apps/web/e2e | 3h |

**Schema `ai_feedback`:**
```sql
CREATE TABLE ai_feedback (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  message_id UUID NOT NULL REFERENCES messages(id) ON DELETE CASCADE,
  account_id UUID NOT NULL REFERENCES accounts(id),
  type TEXT NOT NULL CHECK (type IN ('positive', 'negative')),
  reason TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);
CREATE INDEX idx_ai_feedback_message ON ai_feedback(message_id);
```

**Schema messages (extensi√≥n):**
```sql
ALTER TABLE messages ADD COLUMN refined_from UUID REFERENCES messages(id);
ALTER TABLE messages ADD COLUMN refinement_observation TEXT;
CREATE INDEX idx_messages_refined_from ON messages(refined_from);
```

**Criterios de √âxito:**
- ‚úÖ Usuarios pueden dar üëçüëé a mensajes IA
- ‚úÖ Feedback se almacena con timestamp y accountId
- ‚úÖ Panel de refinaci√≥n permite escribir observaci√≥n
- ‚úÖ Refinaci√≥n genera nuevo mensaje relacionado con original
- ‚úÖ LLM recibe contexto + observaci√≥n para refinar
- ‚úÖ 100% tests E2E para flujo completo

**Consideraciones:**
- **LLM Integration:** Reutilizar servicio existente de fluxcore
- **UI/UX:** Hover menu solo visible en mensajes con `generatedBy: 'ai'`
- **Performance:** √çndices en message_id para queries r√°pidas
- **Seguridad:** Validar que accountId tiene acceso a conversaci√≥n

---

### Hito PC-7: Message Reactions & Hover Menu

**Objetivo:** Implementar sistema de reacciones emoji en mensajes y men√∫ contextual al hacer hover, mejorando interactividad del chat.

**Duraci√≥n estimada:** 5 d√≠as  
**Prioridad:** üî¥ Alta (Core del wireframe)  
**Dependencias:** Hito 2 (Chat Core), Hito 13 (Component Library)  
**Wireframes:** 13 archivos SVG en `apps/web/src/components/Dise√±o de chat/` (hover menu + reacciones)  
**Docs:** `CHAT_WIREFRAME_INVENTORY.md`, `CHAT_WIREFRAME_AUDIT_SUMMARY.md`, `CHAT_BACKEND_FRONTEND_MAPPING.md`  
**Referencia:** Gap G-17 en `CHAT_BACKEND_FRONTEND_MAPPING.md`

| ID | Tarea | Prioridad | Componentes | Estimaci√≥n |
|----|-------|-----------|-------------|------------|
| **FC-1110** | Schema: tabla `message_reactions` | Alta | packages/db | 1h |
| **FC-1111** | Endpoint `POST /messages/:id/reactions` | Alta | apps/api/routes | 2h |
| **FC-1112** | Endpoint `DELETE /messages/:id/reactions/:reactionId` | Alta | apps/api/routes | 1h |
| **FC-1113** | Endpoint `GET /messages/:id/reactions` | Media | apps/api/routes | 1h |
| **FC-1114** | Service: MessageReactionsService | Alta | apps/api/services | 3h |
| **FC-1115** | WebSocket: broadcast `reaction:added` y `reaction:removed` | Alta | apps/api/websocket | 2h |
| **FC-1116** | Frontend: MessageHoverMenu (emoji + options) | Alta | apps/web/components | 4h |
| **FC-1117** | Frontend: EmojiPicker para reacciones | Alta | apps/web/components | 3h |
| **FC-1118** | Frontend: ReactionsList en MessageBubble | Alta | apps/web/components | 3h |
| **FC-1119** | Hook: useMessageReactions | Media | apps/web/hooks | 2h |
| **FC-1120** | Tests E2E: agregar/quitar reacciones | Media | apps/web/e2e | 2h |

**Schema `message_reactions`:**
```sql
CREATE TABLE message_reactions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  message_id UUID NOT NULL REFERENCES messages(id) ON DELETE CASCADE,
  account_id UUID NOT NULL REFERENCES accounts(id),
  emoji TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(message_id, account_id, emoji)
);
CREATE INDEX idx_reactions_message ON message_reactions(message_id);
CREATE INDEX idx_reactions_account ON message_reactions(account_id);
```

**Criterios de √âxito:**
- ‚úÖ Hover sobre mensaje muestra men√∫ con emoji + options
- ‚úÖ Click en emoji abre picker con emojis frecuentes
- ‚úÖ Reacciones se muestran debajo del mensaje agrupadas
- ‚úÖ Click en reacci√≥n existente la quita (toggle)
- ‚úÖ WebSocket notifica reacciones en tiempo real
- ‚úÖ M√∫ltiples usuarios pueden reaccionar al mismo mensaje
- ‚úÖ 100% tests E2E para flujo completo

**Consideraciones:**
- **UI/UX:** Hover menu aparece solo en desktop, en mobile usar long-press
- **Performance:** Agregar reacciones al payload de mensajes para evitar N+1 queries
- **Real-time:** Broadcast solo a usuarios en la conversaci√≥n
- **L√≠mites:** Max 50 reacciones por mensaje para prevenir spam

---

### Hito PC-8: Chat Header & Advanced Features

**Objetivo:** Implementar header completo del chat con tags, asignaci√≥n, b√∫squeda y men√∫ de opciones avanzadas seg√∫n wireframes.

**Duraci√≥n estimada:** 2 semanas  
**Prioridad:** üü° Media (Features secundarias pero importantes)  
**Dependencias:** Hito 2 (Chat Core), Hito 3 (Workspace UI)  
**Wireframes:** 13 archivos SVG en `apps/web/src/components/Dise√±o de chat/` (Frames 10, 15, 16)  
**Docs:** `CHAT_WIREFRAME_INVENTORY.md`, `CHAT_WIREFRAME_AUDIT_SUMMARY.md`, `CHAT_BACKEND_FRONTEND_MAPPING.md`  
**Referencia:** Gaps G-18, G-19, G-20, G-21 en `CHAT_BACKEND_FRONTEND_MAPPING.md`

| ID | Tarea | Prioridad | Componentes | Estimaci√≥n |
|----|-------|-----------|-------------|------------|
| **FC-1121** | Schema: tabla `conversation_tags` | Alta | packages/db | 1h |
| **FC-1122** | Schema: tabla `conversation_assignments` | Alta | packages/db | 1h |
| **FC-1123** | Schema: tabla `blocked_contacts` | Media | packages/db | 1h |
| **FC-1124** | Endpoint `POST /tags` (CRUD tags) | Alta | apps/api/routes | 3h |
| **FC-1125** | Endpoint `POST /conversations/:id/tags` | Alta | apps/api/routes | 2h |
| **FC-1126** | Endpoint `POST /conversations/:id/assign` | Alta | apps/api/routes | 3h |
| **FC-1127** | Endpoint `GET /conversations/:id/search` | Alta | apps/api/routes | 4h |
| **FC-1128** | Endpoint `POST /contacts/:id/block` | Media | apps/api/routes | 2h |
| **FC-1129** | Endpoint `GET /conversations/:id/export` | Baja | apps/api/routes | 4h |
| **FC-1130** | Service: TagsService | Alta | apps/api/services | 3h |
| **FC-1131** | Service: AssignmentService | Alta | apps/api/services | 3h |
| **FC-1132** | Service: ConversationSearchService | Alta | apps/api/services | 5h |
| **FC-1133** | Frontend: ChatHeader completo | Alta | apps/web/components | 4h |
| **FC-1134** | Frontend: ChatOptionsMenu (sidebar) | Alta | apps/web/components | 5h |
| **FC-1135** | Frontend: TagSelector component | Alta | apps/web/components | 3h |
| **FC-1136** | Frontend: AssignmentPicker component | Alta | apps/web/components | 3h |
| **FC-1137** | Frontend: ConversationSearch component | Alta | apps/web/components | 4h |
| **FC-1138** | Hook: useTags, useAssignment, useSearch | Media | apps/web/hooks | 3h |
| **FC-1139** | Tests E2E: tags, assignment, search | Media | apps/web/e2e | 4h |

**Schema `conversation_tags`:**
```sql
CREATE TABLE tags (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  account_id UUID NOT NULL REFERENCES accounts(id),
  workspace_id UUID REFERENCES workspaces(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  color TEXT DEFAULT 'accent',
  created_at TIMESTAMP DEFAULT NOW()
);
-- Herencia: un workspace ve sus tags (workspace_id != null) + tags de cuenta (workspace_id = null)
-- Unicidad recomendada (evitar duplicados dentro del mismo scope):
-- 1) Tags de cuenta: UNIQUE(account_id, name) WHERE workspace_id IS NULL
-- 2) Tags de workspace: UNIQUE(workspace_id, name) WHERE workspace_id IS NOT NULL

CREATE TABLE conversation_tags (
  conversation_id UUID NOT NULL REFERENCES conversations(id) ON DELETE CASCADE,
  tag_id UUID NOT NULL REFERENCES tags(id) ON DELETE CASCADE,
  created_at TIMESTAMP DEFAULT NOW(),
  PRIMARY KEY(conversation_id, tag_id)
);
CREATE INDEX idx_conversation_tags_conv ON conversation_tags(conversation_id);
CREATE INDEX idx_conversation_tags_tag ON conversation_tags(tag_id);
```

**Schema `conversation_assignments`:**
```sql
CREATE TABLE conversation_assignments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  conversation_id UUID NOT NULL REFERENCES conversations(id) ON DELETE CASCADE,
  workspace_id UUID NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE,
  assigned_to_user_id UUID NOT NULL REFERENCES users(id),
  assigned_by_user_id UUID NOT NULL REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(conversation_id, assigned_to_user_id)
);
CREATE INDEX idx_assignments_conversation ON conversation_assignments(conversation_id);
CREATE INDEX idx_assignments_workspace ON conversation_assignments(workspace_id);
CREATE INDEX idx_assignments_user ON conversation_assignments(assigned_to_user_id);
```

**Criterios de √âxito:**
- ‚úÖ Header muestra: volver, nombre, tel√©fono, #, @, ‚ãÆ
- ‚úÖ Tags (#) permite crear y asignar etiquetas con colores
- ‚úÖ Asignaci√≥n (@) permite asignar conversaci√≥n a otro usuario
- ‚úÖ B√∫squeda encuentra mensajes por texto en conversaci√≥n
- ‚úÖ Men√∫ opciones muestra 10 acciones (reenviar, calendario, etc.)
- ‚úÖ Bloqueo de contactos impide recibir mensajes
- ‚úÖ Export genera JSON/CSV de conversaci√≥n
- ‚úÖ 100% tests E2E para flujos principales

**Consideraciones:**
- **Tags:** Sistema similar a labels de Gmail, m√∫ltiples tags por conversaci√≥n
  - Scope: tags de **cuenta** + tags de **workspace** (herencia)
  - Precedencia: en conflictos de nombre, prevalece workspace
- **Assignment (@):** **asignaci√≥n + notificaci√≥n (workflow), no permisos**
  - Target: miembro del workspace (`workspace_members.user_id`)
  - Wireframe sugiere `acceso completo` / `acceso a seleccionados`
  - `acceso a seleccionados`: notifica/dirige a **mensajes seleccionados** (PC-10) sin cambios de permisos
- **Search:** Full-text search en PostgreSQL usando `to_tsvector`
  - Requiere estrategia para indexar `messages.content` (JSONB) + un √≠ndice `GIN` para b√∫squeda
  - Recomendado un √≠ndice `btree` en `(conversation_id, created_at)` para paginaci√≥n estable
- **Blocked:** Soft-block, mensajes se reciben pero no notifican

---

### Hito PC-9: File Upload System (Generic)

**Objetivo:** Implementar sistema gen√©rico de subida de archivos para mensajes (documentos, im√°genes, audio, video) con validaci√≥n y almacenamiento seguro.

**Duraci√≥n estimada:** 1 semana  
**Prioridad:** üî¥ Alta (Core del wireframe - AttachmentPanel)  
**Dependencias:** Hito 2 (Chat Core), Hito PC-1 (Avatar Upload)  
**Wireframes:** 13 archivos SVG en `apps/web/src/components/Dise√±o de chat/` (Input + AttachmentPanel)  
**Docs:** `CHAT_WIREFRAME_INVENTORY.md`, `CHAT_WIREFRAME_AUDIT_SUMMARY.md`, `CHAT_BACKEND_FRONTEND_MAPPING.md`  
**Referencia:** Gaps G-01, G-02 en `CHAT_BACKEND_FRONTEND_MAPPING.md`

| ID | Tarea | Prioridad | Componentes | Estimaci√≥n |
|----|-------|-----------|-------------|------------|
| **FC-1140** | Schema: tabla `media_attachments` | Alta | packages/db | 1h |
| **FC-1141** | Endpoint `POST /upload/file` (gen√©rico) | Alta | apps/api/routes | 4h |
| **FC-1142** | Endpoint `POST /upload/audio` (notas de voz) | Alta | apps/api/routes | 3h |
| **FC-1143** | Service: FileUploadService con validaci√≥n | Alta | apps/api/services | 5h |
| **FC-1144** | Service: AudioProcessingService (waveform) | Media | apps/api/services | 4h |
| **FC-1145** | Middleware: file size limits y mime-type validation | Alta | apps/api/middleware | 2h |
| **FC-1146** | Storage: organizar /uploads por tipo y fecha | Alta | apps/api/server | 2h |
| **FC-1147** | Frontend: AttachmentPanel completo (8 tipos) | Alta | apps/web/components | 6h |
| **FC-1148** | Frontend: FileUploader component | Alta | apps/web/components | 4h |
| **FC-1149** | Frontend: AudioRecorder component | Alta | apps/web/components | 5h |
| **FC-1150** | Frontend: AudioWaveform visualization | Media | apps/web/components | 3h |
| **FC-1151** | Hook: useFileUpload, useAudioRecorder | Alta | apps/web/hooks | 4h |
| **FC-1152** | Tests E2E: upload de cada tipo de archivo | Alta | apps/web/e2e | 4h |

**Schema `media_attachments`:**
```sql
CREATE TABLE media_attachments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  message_id UUID REFERENCES messages(id) ON DELETE CASCADE,
  type TEXT NOT NULL CHECK (type IN ('image', 'document', 'audio', 'video', 'location', 'contact')),
  url TEXT NOT NULL,
  filename TEXT NOT NULL,
  mime_type TEXT NOT NULL,
  size_bytes INTEGER NOT NULL,
  duration_seconds INTEGER,
  thumbnail_url TEXT,
  waveform_data JSONB,
  metadata JSONB DEFAULT '{}'::jsonb,
  created_at TIMESTAMP DEFAULT NOW()
);
CREATE INDEX idx_attachments_message ON media_attachments(message_id);
CREATE INDEX idx_attachments_type ON media_attachments(type);
```

**L√≠mites de archivos:**
```typescript
const FILE_LIMITS = {
  image: { maxSize: 10 * 1024 * 1024, mimes: ['image/jpeg', 'image/png', 'image/webp'] },
  document: { maxSize: 50 * 1024 * 1024, mimes: ['application/pdf', 'application/msword', 'text/plain'] },
  audio: { maxSize: 20 * 1024 * 1024, mimes: ['audio/webm', 'audio/mp3', 'audio/ogg'] },
  video: { maxSize: 100 * 1024 * 1024, mimes: ['video/mp4', 'video/webm'] }
};
```

**Criterios de √âxito:**
- ‚úÖ AttachmentPanel muestra 8 tipos: documento, c√°mara, galer√≠a, audio, recibo, ubicaci√≥n, quick reply, contacto
- ‚úÖ Upload valida tipo MIME y tama√±o antes de enviar
- ‚úÖ Archivos se almacenan en `/uploads/{type}/{YYYY-MM-DD}/{uuid}.ext`
- ‚úÖ Audio genera waveform data para visualizaci√≥n
- ‚úÖ Im√°genes generan thumbnail autom√°ticamente
- ‚úÖ Progress bar durante upload
- ‚úÖ Mensajes con attachments muestran preview
- ‚úÖ 100% tests E2E para cada tipo

**Evidencia m√≠nima (2025-12-14):**
- DB schema: `packages/db/src/schema/media-attachments.ts`
- DB migration (manual): `packages/db/migrations/012_media_attachments.sql`
- API: endpoints `POST /upload/file` y `POST /upload/audio`: `apps/api/src/routes/upload.routes.ts`
- API: FileUploadService + AudioProcessingService: 
  - `apps/api/src/services/file-upload.service.ts`
  - `apps/api/src/services/audio-processing.service.ts`
- API: link attachments a mensaje por `content.media[].attachmentId`: `apps/api/src/services/message.service.ts`
- Web: ApiService soporta `FormData` (no fuerza JSON): `apps/web/src/services/api.ts`
- Web: AttachmentPanel + hook upload + previews:
  - `apps/web/src/components/chat/AttachmentPanel.tsx`
  - `apps/web/src/hooks/useFileUpload.ts`
  - `apps/web/src/components/chat/ChatView.tsx`
  - `apps/web/src/components/chat/MessageBubble.tsx`
- Verificaci√≥n ejecutada:
  - `apps/api` ‚Üí `bun run build` (OK)
  - `apps/web` ‚Üí `bun run build` (OK)
  - `apps/web` ‚Üí `bun run test -- --run` (OK)

**Pendiente para completar PC-9 al 100%:**
- Thumbnails reales (sharp) (FC-1146/FC-1144)
- Waveform real + visualizaci√≥n dedicada (FC-1144/FC-1150)
- E2E uploads por tipo (FC-1152)

**Gu√≠a de verificaci√≥n manual:**
1. Ejecutar `cd packages/db` ‚Üí `bun run db:push` para aplicar `media_attachments`.
2. Iniciar sistema (`bun run dev`).
3. Abrir un chat ‚Üí click üìé ‚Üí subir imagen/documento/audio ‚Üí ver progress bar.
4. El mensaje se env√≠a con preview (imagen, audio, documento).

**Consideraciones:**
- **Storage:** Usar filesystem local, preparar para S3 en futuro
- **Thumbnails:** Usar sharp para generar thumbnails de im√°genes
- **Waveform:** Usar audiowaveform o Web Audio API
- **Security:** Sanitizar nombres de archivo, validar magic bytes

---

### Hito PC-10: Message Actions & Batch Operations

**Objetivo:** Implementar acciones sobre mensajes (forward, flag, batch delete) y barra de selecci√≥n m√∫ltiple seg√∫n wireframes.

**Duraci√≥n estimada:** 5 d√≠as  
**Prioridad:** üî¥ Alta (Core del wireframe - MessageSelectionBar)  
**Dependencias:** Hito 2 (Chat Core), Hito 13 (Component Library)  
**Wireframes:** 13 archivos SVG en `apps/web/src/components/Dise√±o de chat/` (modo selecci√≥n)  
**Docs:** `CHAT_WIREFRAME_INVENTORY.md`, `CHAT_WIREFRAME_AUDIT_SUMMARY.md`, `CHAT_BACKEND_FRONTEND_MAPPING.md`  
**Referencia:** Gaps G-04, G-05, G-06 en `CHAT_BACKEND_FRONTEND_MAPPING.md`

| ID | Tarea | Prioridad | Componentes | Estimaci√≥n |
|----|-------|-----------|-------------|------------|
| **FC-1153** | Schema: campos `flagged`, `flag_type`, `forwarded_from` en messages | Alta | packages/db | 30min |
| **FC-1154** | Endpoint `POST /messages/forward` | Alta | apps/api/routes | 3h |
| **FC-1155** | Endpoint `DELETE /messages/batch` | Alta | apps/api/routes | 2h |
| **FC-1156** | Endpoint `PATCH /messages/:id/flag` | Alta | apps/api/routes | 2h |
| **FC-1157** | Endpoint `GET /messages/flagged` | Media | apps/api/routes | 2h |
| **FC-1158** | Service: MessageActionsService | Alta | apps/api/services | 4h |
| **FC-1159** | WebSocket: broadcast `message:forwarded`, `message:deleted` | Alta | apps/api/websocket | 2h |
| **FC-1160** | Frontend: MessageSelectionBar completo | Alta | apps/web/components | 5h |
| **FC-1161** | Frontend: MessageSelectionCheckbox | Alta | apps/web/components | 2h |
| **FC-1162** | Frontend: ForwardDialog (seleccionar conversaci√≥n) | Alta | apps/web/components | 4h |
| **FC-1163** | Frontend: FlagSelector (important/followup/custom) | Media | apps/web/components | 2h |
| **FC-1164** | Hook: useMessageSelection | Alta | apps/web/hooks | 3h |
| **FC-1165** | Tests E2E: selecci√≥n, forward, batch delete, flag | Alta | apps/web/e2e | 4h |

**Schema messages (extensi√≥n):**
```sql
ALTER TABLE messages ADD COLUMN flagged BOOLEAN DEFAULT FALSE;
ALTER TABLE messages ADD COLUMN flag_type TEXT CHECK (flag_type IN ('important', 'followup', 'custom'));
ALTER TABLE messages ADD COLUMN forwarded_from UUID REFERENCES messages(id);
CREATE INDEX idx_messages_flagged ON messages(flagged) WHERE flagged = TRUE;
CREATE INDEX idx_messages_forwarded ON messages(forwarded_from);
```

**Endpoints:**
```typescript
POST /messages/forward
  body: {
    messageIds: string[],
    targetConversationId: string,
    senderAccountId: string
  }
  returns: { forwardedMessages: Message[] }

DELETE /messages/batch
  body: { messageIds: string[] }
  returns: { deleted: number }

PATCH /messages/:id/flag
  body: {
    flagged: boolean,
    flagType?: 'important' | 'followup' | 'custom'
  }
  returns: Message
```

**Criterios de √âxito:**
- ‚úÖ Long-press en mensaje activa modo selecci√≥n
- ‚úÖ MessageSelectionBar muestra: X, contador, forward, copy, flag, download, delete
- ‚úÖ Checkbox aparece en cada mensaje durante selecci√≥n
- ‚úÖ Forward abre di√°logo para elegir conversaci√≥n destino
- ‚úÖ Batch delete elimina m√∫ltiples mensajes en una transacci√≥n
- ‚úÖ Flag marca mensajes con tipos (important/followup/custom)
- ‚úÖ Copy copia texto al clipboard (frontend only)
- ‚úÖ WebSocket notifica acciones en tiempo real
- ‚úÖ 100% tests E2E para flujo completo

**Consideraciones:**
- **Transacciones:** Batch delete debe ser at√≥mico (todo o nada)
- **Forward:** Crear nuevos mensajes con referencia al original
- **Permisos:** Validar que usuario tiene acceso a conversaci√≥n destino
- **UI/UX:** Salir de modo selecci√≥n al completar acci√≥n

---

### Hito 27: Chat Robustness & UX

**Objetivo:** Resolver problemas cr√≠ticos de UX en el sistema de chat identificados en auditor√≠a.

**Duraci√≥n estimada:** 1 semana

**Prioridad:** Alta (afecta experiencia de usuario directamente)

**Referencia:** `CREACION DE HITOS.md` - Issues 1, 4

| ID | Tarea | Prioridad | Descripci√≥n |
|----|-------|-----------|-------------|
| **FC-1000** | Prevenir duplicaci√≥n de tabs de chat | Alta | Verificar existencia de tab antes de crear nuevo |
| **FC-1001** | Implementar estado "enviando" en ChatView | Alta | isSending reflejado en UI con spinner/disabled |
| **FC-1002** | Exponer errores de WS al UI | Alta | useWebSocket expone error state, ChatView lo muestra |
| **FC-1003** | Error boundary para ChatView | Media | Capturar errores y mostrar fallback |
| **FC-1004** | Indicador de conexi√≥n WS | Media | Badge de estado: conectado/reconectando/desconectado |
| **FC-1005** | Toast de errores de API | Media | Notificaciones visuales de errores |

**Implementaci√≥n FC-1000 (Prevenir duplicaci√≥n):**
```typescript
// ViewPort.tsx - Antes de crear tab
const existingTab = containers
  .flatMap(c => c.tabs.map(t => ({ tab: t, containerId: c.id })))
  .find(({ tab }) => tab.type === 'chat' && tab.context?.chatId === selectedConversationId);

if (existingTab) {
  // Activar tab existente en lugar de crear nuevo
  setActiveTab(existingTab.containerId, existingTab.tab.id);
  return;
}
```

**Implementaci√≥n FC-1001 (Estado enviando):**
```typescript
// ChatView.tsx
const [isSending, setIsSending] = useState(false);

const handleSend = async () => {
  setIsSending(true);
  try {
    await sendMessage(content);
  } finally {
    setIsSending(false);
  }
};

// En UI
<Button disabled={isSending} loading={isSending}>Enviar</Button>
```

**Criterios de √©xito:**
- [x] No se crean tabs duplicados para la misma conversaci√≥n
- [x] Usuario ve spinner al enviar mensaje
- [x] Errores de WS se muestran visualmente
- [x] Indicador de estado de conexi√≥n visible

**Evidencia m√≠nima (2025-12-14):**
- Frontend: indicador de conexi√≥n + errores WS visibles + reintentar: `apps/web/src/components/chat/ChatView.tsx`
- Frontend: WS expone `lastError` + `reconnectAttempts`: `apps/web/src/hooks/useWebSocket.ts`
- Frontend: Error Boundary para ChatView: `apps/web/src/components/panels/DynamicContainer.tsx`
- Build verificado: `apps/web` ‚Üí `bun run build` (OK)

**Gu√≠a de verificaci√≥n manual:**
1. Abrir una conversaci√≥n y presionar ‚ÄúEnviar‚Äù varias veces r√°pido ‚Üí no duplica env√≠o y muestra spinner/disabled mientras env√≠a.
2. Apagar backend / cortar conectividad ‚Üí header muestra ‚ÄúConectando.../Sin conexi√≥n‚Äù y aparece banner con detalle + bot√≥n ‚ÄúReintentar‚Äù.
3. Reactivar backend ‚Üí estado vuelve a ‚ÄúEn l√≠nea‚Äù y el banner desaparece.

---

### Hito 28: Security Hardening

**Objetivo:** Mejorar seguridad del sistema, especialmente autenticaci√≥n y tokens.

**Duraci√≥n estimada:** 1.5 semanas

**Prioridad:** Alta (seguridad cr√≠tica)

**Referencia:** `CREACION DE HITOS.md` - Issue 5, WebSocket Security

| ID | Tarea | Prioridad | Descripci√≥n |
|----|-------|-----------|-------------|
| **FC-1010** | Migrar tokens a httpOnly cookies | Alta | Eliminar localStorage, usar cookies seguras |
| **FC-1011** | Configurar CSP headers | Alta | Content-Security-Policy en respuestas |
| **FC-1012** | Autenticaci√≥n durante upgrade WS | Alta | Validar token en handshake WebSocket |
| **FC-1013** | Rate limiting por IP | Alta | Limitar requests por IP en endpoints cr√≠ticos |
| **FC-1014** | Sanitizaci√≥n de inputs | Media | Validar y sanitizar todos los inputs de usuario |
| **FC-1015** | Audit logging | Media | Log de acciones sensibles (login, cambio password) |
| **FC-1016** | CORS estricto | Media | Configurar origins permitidos |

**Implementaci√≥n FC-1010 (httpOnly cookies):**
```typescript
// auth.service.ts
const setCookie = (res: Response, token: string) => {
  res.cookie('fluxcore_token', token, {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    sameSite: 'strict',
    maxAge: 7 * 24 * 60 * 60 * 1000 // 7 d√≠as
  });
};

// authStore.ts - Ya no usa localStorage
// Token se env√≠a autom√°ticamente con credentials: 'include'
```

**Implementaci√≥n FC-1012 (WS Auth):**
```typescript
// websocket.ts - Validar en upgrade
app.ws('/ws', {
  upgrade: async (req, socket, head) => {
    const token = req.cookies?.fluxcore_token;
    if (!token || !validateToken(token)) {
      socket.write('HTTP/1.1 401 Unauthorized\r\n\r\n');
      socket.destroy();
      return;
    }
    // Proceder con upgrade
  }
});
```

**Criterios de √©xito:**
- [ ] Token NO est√° en localStorage (verificar DevTools)
- [ ] CSP headers presentes en respuestas
- [ ] WS rechaza conexiones sin token v√°lido
- [ ] Rate limiting activo (429 despu√©s de N requests)

---

### Hito 29: Performance & Optimization

**Objetivo:** Optimizar rendimiento del frontend y backend.

**Duraci√≥n estimada:** 1 semana

**Prioridad:** Media

**Referencia:** `CREACION DE HITOS.md` - Issue 3, Performance

| ID | Tarea | Prioridad | Descripci√≥n |
|----|-------|-----------|-------------|
| **FC-1020** | useMemo en ConversationsList | Alta | Memoizar filteredConversations |
| **FC-1021** | useCallback en handlers | Alta | Evitar re-renders por funciones nuevas |
| **FC-1022** | Virtualizaci√≥n de listas largas | Media | react-window para conversaciones/mensajes |
| **FC-1023** | Compresi√≥n de mensajes largos | Media | gzip para mensajes >1KB |
| **FC-1024** | Paginaci√≥n de historiales | Alta | Cargar mensajes en chunks de 50 |
| **FC-1025** | Lazy loading de componentes pesados | Media | React.lazy para Settings, Extensions |
| **FC-1026** | Debounce en b√∫squedas | Media | 300ms debounce en inputs de b√∫squeda |

**Implementaci√≥n FC-1020 (useMemo):**
```typescript
// ConversationsList.tsx
const filteredConversations = useMemo(
  () => conversations.filter((conv) => {
    if (!searchQuery) return true;
    const search = searchQuery.toLowerCase();
    return conv.lastMessageText?.toLowerCase().includes(search) ||
           conv.channel.toLowerCase().includes(search);
  }),
  [conversations, searchQuery]
);
```

**Implementaci√≥n FC-1022 (Virtualizaci√≥n):**
```typescript
import { FixedSizeList as List } from 'react-window';

<List
  height={400}
  itemCount={messages.length}
  itemSize={80}
  width="100%"
>
  {({ index, style }) => (
    <MessageBubble message={messages[index]} style={style} />
  )}
</List>
```

**Criterios de √©xito:**
- [ ] React DevTools no muestra re-renders innecesarios
- [ ] Listas de 1000+ items renderizan sin lag
- [ ] Historial de chat carga en <500ms
- [ ] Bundle size reducido (verificar con bundle analyzer)

---

### Hito 30: Monitoring & Observability

**Objetivo:** Implementar m√©tricas y monitoreo para producci√≥n.

**Duraci√≥n estimada:** 1 semana

**Prioridad:** Media

**Referencia:** `CREACION DE HITOS.md` - Monitoring, Resiliencia

| ID | Tarea | Prioridad | Descripci√≥n |
|----|-------|-----------|-------------|
| **FC-1030** | M√©tricas de conexiones WS | Alta | Contador de conexiones activas |
| **FC-1031** | M√©tricas de tiempo de reconexi√≥n | Media | Histograma de tiempos de reconexi√≥n |
| **FC-1032** | Contador de mensajes perdidos | Media | Tracking de mensajes no entregados |
| **FC-1033** | Circuit breaker para APIs externas | Alta | Fallback cuando Groq/otros fallan |
| **FC-1034** | Health check endpoint mejorado | Media | /health con detalles de DB, WS, extensiones |
| **FC-1035** | Logger service centralizado | Alta | Reemplazar console.log con logger estructurado |
| **FC-1036** | Error tracking (Sentry/similar) | Media | Captura autom√°tica de errores en producci√≥n |

**Implementaci√≥n FC-1033 (Circuit Breaker):**
```typescript
import CircuitBreaker from 'opossum';

const groqBreaker = new CircuitBreaker(callGroqAPI, {
  timeout: 10000,
  errorThresholdPercentage: 50,
  resetTimeout: 30000
});

groqBreaker.fallback(() => ({
  success: false,
  message: 'AI service temporarily unavailable'
}));

groqBreaker.on('open', () => logger.warn('Groq circuit OPEN'));
groqBreaker.on('halfOpen', () => logger.info('Groq circuit HALF-OPEN'));
groqBreaker.on('close', () => logger.info('Groq circuit CLOSED'));
```

**Implementaci√≥n FC-1035 (Logger):**
```typescript
// logger.ts
import pino from 'pino';

export const logger = pino({
  level: process.env.LOG_LEVEL || 'info',
  transport: process.env.NODE_ENV === 'development'
    ? { target: 'pino-pretty' }
    : undefined
});

// Uso
logger.info({ userId, action: 'login' }, 'User logged in');
logger.error({ err, endpoint }, 'API call failed');
```

**Criterios de √©xito:**
- [ ] Dashboard muestra conexiones WS activas
- [ ] Circuit breaker activa fallback cuando Groq falla
- [ ] Logs estructurados en JSON en producci√≥n
- [ ] /health retorna estado detallado de servicios

---

## Hito 31: Frontend Error Fixes (NUEVO)

**Objetivo:** Corregir errores cr√≠ticos de frontend identificados en auditor√≠a de c√≥digo.

**Duraci√≥n estimada:** 1 semana

**Prioridad:** Alta (errores cr√≠ticos en producci√≥n)

**Referencia:** Auditor√≠a de frontend - 19 errores encontrados

| ID | Tarea | Prioridad | Descripci√≥n | Archivos afectados |
|----|-------|-----------|-------------|-------------------|
| **FC-1100** | Corregir colores hardcodeados en SystemMonitor | Alta | Reemplazar text-green-500, text-red-500, text-blue-500 con clases can√≥nicas | SystemMonitor.tsx |
| **FC-1101** | Optimizar filteredConversations con useMemo | Alta | Evitar re-renders en cada b√∫squeda | ConversationsList.tsx |
| **FC-1102** | Migrar token storage a httpOnly cookies | Alta | Eliminar localStorage vulnerable a XSS | authStore.ts, api.ts |
| **FC-1103** | Implementar feedback visual isSending | Alta | Mostrar spinner al enviar mensaje | ChatView.tsx |
| **FC-1104** | A√±adir aria-labels para accesibilidad | Media | Labels en checkboxes y botones | SystemMonitor.tsx |
| **FC-1105** | Error boundary para componentes cr√≠ticos | Media | Capturar errores y mostrar fallback | ChatView.tsx, ViewPort.tsx |
| **FC-1106** | Virtualizar listas largas | Media | react-window para >100 items | ConversationsList.tsx |
| **FC-1107** | Sanitizar inputs de usuario | Alta | Prevener XSS en todos los inputs | Formularios varios |
| **FC-1108** | Implementar debounce en b√∫squedas | Media | 300ms debounce en search inputs | ConversationsList.tsx, ContactsList.tsx |

**Implementaci√≥n FC-1100 (Colores):**
```typescript
// SystemMonitor.tsx - Reemplazar
return <CheckCircle className="w-5 h-5 text-green-500" />
// Por
return <CheckCircle className="w-5 h-5 text-success" />

return <XCircle className="w-5 h-5 text-red-500" />
// Por
return <XCircle className="w-5 h-5 text-error" />

<Database className="w-6 h-6 text-blue-500" />
// Por
<Database className="w-6 h-6 text-accent" />
```

**Implementaci√≥n FC-1101 (useMemo):**
```typescript
// ConversationsList.tsx
const filteredConversations = useMemo(
  () => conversations.filter((conv) => {
    if (!searchQuery) return true;
    const search = searchQuery.toLowerCase();
    return conv.lastMessageText?.toLowerCase().includes(search) ||
           conv.channel.toLowerCase().includes(search);
  }),
  [conversations, searchQuery]
);
```

**Implementaci√≥n FC-1102 (httpOnly cookies):**
```typescript
// auth.service.ts
const setCookie = (res: Response, token: string) => {
  res.cookie('fluxcore_token', token, {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    sameSite: 'strict',
    maxAge: 7 * 24 * 60 * 60 * 1000 // 7 d√≠as
  });
};

// authStore.ts - Ya no usa localStorage
// Token se env√≠a autom√°ticamente con credentials: 'include'
```

**Criterios de √©xito:**
- [ ] SystemMonitor usa solo clases can√≥nicas del DESIGN_SYSTEM
- [ ] React DevTools no muestra re-renders en b√∫squedas
- [ ] Token no visible en localStorage (verificar DevTools)
- [ ] Usuario ve spinner al enviar mensaje
- [ ] Screen reader puede navegar controles

---

## Hito 32: Chat Layout & UX Fixes (NUEVO)

**Objetivo:** Corregir errores cr√≠ticos de layout en ChatView y eliminar elementos mock no funcionales.

**Duraci√≥n estimada:** 0.5 semanas

**Prioridad:** Alta (errores visibles en producci√≥n)

**Referencia:** Error de input flotante y botones mock identificados por usuario

| ID | Tarea | Prioridad | Descripci√≥n | Archivos afectados |
|----|-------|-----------|-------------|-------------------|
| **FC-1120** | Corregir layout de ChatView | Alta | A√±adir min-h-0 al √°rea de mensajes para evitar input flotante | ChatView.tsx |
| **FC-1121** | Remover botones mock no funcionales | Alta | Eliminar Phone, Video, MoreVertical o implementar funcionalidad | ChatView.tsx |
| **FC-1122** | Implementar estado isSending en UI | Alta | Mostrar spinner en bot√≥n Send durante env√≠o | ChatView.tsx |
| **FC-1123** | Conectar AI Suggestions a API real | Media | Remover mock y conectar a fluxcore extension | ChatView.tsx |
| **FC-1124** | Implementar eliminaci√≥n de mensajes | Alta | Habilitar onDelete en MessageBubble con confirmaci√≥n | MessageBubble.tsx |
| **FC-1125** | A√±adir debounce en input de mensaje | Media | 300ms debounce para evitar requests innecesarios | ChatView.tsx |
| **FC-1126** | Mejorar scroll autom√°tico | Media | Scroll suave al √∫ltimo mensaje con offset para input | ChatView.tsx |

**Implementaci√≥n FC-1120 (Layout Fix):**
```typescript
// ChatView.tsx - L√≠nea 172
// ANTES:
<div className="flex-1 overflow-y-auto p-4 space-y-3">

// DESPU√âS:
<div className="flex-1 overflow-y-auto p-4 space-y-3 min-h-0">
```

**Implementaci√≥n FC-1121 (Remover Botones Mock):**
```typescript
// ChatView.tsx - L√≠neas 137-147
// REMOVER:
<button className="p-2 text-secondary hover:text-primary hover:bg-hover rounded-lg transition-colors">
  <Phone size={20} />
</button>
<button className="p-2 text-secondary hover:text-primary hover:bg-hover rounded-lg transition-colors">
  <Video size={20} />
</button>
<button className="p-2 text-secondary hover:text-primary hover:bg-hover rounded-lg transition-colors">
  <MoreVertical size={20} />
</button>

// REEMPLAZAR CON:
<div className="flex items-center gap-1">
  {/* Espacio para futuras acciones reales */}
</div>
```

**Implementaci√≥n FC-1122 (Estado isSending):**
```typescript
// ChatView.tsx
const [isSending, setIsSending] = useState(false);

const handleSend = async () => {
  setIsSending(true);
  try {
    await sendMessage(content);
  } finally {
    setIsSending(false);
  }
};

// En bot√≥n Send (l√≠nea 266-277):
<button
  onClick={() => handleSend()}
  disabled={!message.trim() || isSending}
  className={clsx(
    'p-3 rounded-full transition-colors',
    message.trim() && !isSending
      ? 'bg-accent text-inverse hover:bg-accent-hover'
      : 'bg-elevated text-muted cursor-not-allowed'
  )}
>
  {isSending ? (
    <Loader2 size={20} className="animate-spin" />
  ) : (
    <Send size={20} />
  )}
</button>
```

**Implementaci√≥n FC-1124 (Eliminar Mensajes):**
```typescript
// MessageBubble.tsx - Mejorar handleDelete
const handleDelete = async () => {
  if (!onDelete) return;
  
  // Confirmaci√≥n antes de eliminar
  const confirmed = window.confirm('¬øEliminar este mensaje?');
  if (!confirmed) return;
  
  try {
    await onDelete(message.id);
    // Opcional: mostrar toast de √©xito
  } catch (err) {
    console.error('Delete error:', err);
    // Mostrar error al usuario
  }
};
```

**Criterios de √©xito:**
- [ ] Input de mensaje no flota, permanece en bottom
- [ ] No hay botones mock sin funcionalidad
- [ ] Usuario ve spinner durante env√≠o de mensaje
- [ ] Mensajes pueden eliminarse con confirmaci√≥n
- [ ] Scroll funciona correctamente con input fijo

---

### Hito 33: Mock Elements Cleanup (NUEVO)

**Objetivo:** Eliminar todos los elementos mock y "Pr√≥ximamente" sin implementaci√≥n real.

**Duraci√≥n estimada:** 1 semana

**Prioridad:** Media (limpieza t√©cnica y UX)

| ID | Tarea | Prioridad | Descripci√≥n |
|----|-------|-----------|-------------|
| **FC-1130** | Remover "Pr√≥ximamente" de Settings | Alta | Implementar o eliminar secciones no funcionales | SettingsTabContent.tsx |
| **FC-1131** | Implementar ContactDetailView | Media | Vista detallada real para contactos | DynamicContainer.tsx |
| **FC-1132** | Implementar ExtensionView | Media | Cargar UI real de extensiones | DynamicContainer.tsx |
| **FC-1133** | Remover TODOs sin implementar | Baja | Limpiar comentarios TODO obsoletos | M√∫ltiples archivos |
| **FC-1134** | Implementar CloseContainerDialog | Baja | Di√°logo para √∫ltimo container | DynamicContainer.tsx |
| **FC-1135** | Migrar clases CSS legacy | Media | Eliminar .bg-theme-* obsoletas | CSS global |

**Implementaci√≥n FC-1130 (Settings Cleanup):**
```typescript
// DynamicContainer.tsx - SettingsTabContent
case 'notifications':
  return (
    <div className="h-full flex items-center justify-center">
      <div className="text-center">
        <p className="text-lg text-secondary">Notificaciones</p>
        <p className="text-sm text-muted mt-2">Pr√≥ximamente</p>
      </div>
    </div>
  );

// REMOVER O IMPLEMENTAR:
// Opci√≥n 1: Remover completamente
// Opci√≥n 2: Implementar UI b√°sica de notificaciones
```

**Criterios de √©xito:**
- [ ] No hay textos "Pr√≥ximamente" visibles para usuario
- [ ] Contactos tienen vista detallada funcional
- [ ] Extensiones muestran su UI real
- [ ] TODOs obsoletos eliminados

---

---

### Hito 35: Arquitectura de Cambio de Cuenta Global - CR√çTICO

**Objetivo:** Cuando el usuario cambia de cuenta, TODO el workspace debe cambiar: conversaciones, contactos, extensiones, datos.

**Duraci√≥n:** 1 semana

**Contexto:** El AccountSwitcher actualmente solo cambia parcialmente el estado. El usuario ve "¬°Hola, Harold Ord√≥√±ez!" mientras edita el sitio de Karen. Esto es un error cr√≠tico de UX y arquitectura.

**Problema Ra√≠z:** Existen dos stores desincronizados (`uiStore` y `accountStore`) que manejan cuentas de forma independiente.

| ID | Descripci√≥n | Prioridad | Archivos Afectados | Estado |
|----|-------------|-----------|-------------------|--------|
| **ACC-001** | Unificar stores: accountStore como fuente √∫nica de verdad | CR√çTICA | `accountStore.ts`, `uiStore.ts` | ‚è≥ |
| **ACC-002** | AccountSwitcher actualiza TODO el workspace | CR√çTICA | `AccountSwitcher.tsx`, `Layout.tsx` | ‚è≥ |
| **ACC-003** | Recargar conversaciones al cambiar cuenta | CR√çTICA | `ConversationsList.tsx`, `uiStore.ts` | ‚è≥ |
| **ACC-004** | Recargar contactos al cambiar cuenta | CR√çTICA | `ContactsList.tsx` | ‚è≥ |
| **ACC-005** | Recargar extensiones al cambiar cuenta | CR√çTICA | `useExtensions.ts`, `ActivityBar.tsx` | ‚è≥ |
| **ACC-006** | Limpiar tabs abiertos al cambiar cuenta | ALTA | `panelStore.ts` | ‚è≥ |
| **ACC-007** | Actualizar saludo/welcome con cuenta activa | ALTA | `WelcomeView.tsx` | ‚è≥ |

**Arquitectura Propuesta:**
```typescript
// accountStore.ts - FUENTE √öNICA DE VERDAD
interface AccountState {
  accounts: Account[];
  activeAccountId: string | null;
  activeAccount: Account | null; // computed
}

// Al cambiar cuenta:
const switchAccount = async (accountId: string) => {
  // 1. Actualizar activeAccountId
  set({ activeAccountId: accountId });
  
  // 2. Limpiar datos del workspace anterior
  usePanelStore.getState().closeAllTabs();
  
  // 3. Recargar datos del nuevo workspace
  await Promise.all([
    loadConversations(accountId),
    loadContacts(accountId),
    loadExtensions(accountId),
  ]);
  
  // 4. Notificar cambio global
  eventBus.emit('account:changed', accountId);
};
```

**Criterios de √âxito:**
- [ ] Al cambiar de cuenta, el saludo muestra el nombre correcto
- [ ] Las conversaciones son las de la cuenta activa
- [ ] Los contactos son los de la cuenta activa
- [ ] Las extensiones (Globe) corresponden a la cuenta activa
- [ ] Los tabs se cierran al cambiar de cuenta
- [ ] No hay datos mezclados entre cuentas

---

### Hito 36: Arquitectura UI Can√≥nica - WebsiteBuilderPanel - CR√çTICO

**Objetivo:** Corregir la distribuci√≥n de UI del WebsiteBuilderPanel para respetar el patr√≥n can√≥nico: `ActivityBar ‚Üí Sidebar (lista) ‚Üí DynamicContainer (contenido/tabs)`

**Duraci√≥n:** 0.5 semanas

**Contexto:** El WebsiteBuilderPanel actualmente muestra el editor de p√°ginas en el √°rea de Sidebar. Deber√≠a mostrar solo la lista de p√°ginas en Sidebar, y el editor en DynamicContainer como tab.

**Problema Ra√≠z:** El componente WebsiteBuilderPanel mezcla lista y editor en un solo componente que se renderiza en Sidebar.

| ID | Descripci√≥n | Prioridad | Archivos Afectados | Estado |
|----|-------------|-----------|-------------------|--------|
| **UI-001** | Separar WebsiteBuilderPanel en Sidebar (lista) y Tab (editor) | CR√çTICA | `WebsiteBuilderPanel.tsx` | ‚è≥ |
| **UI-002** | Crear WebsitePageEditor como componente de tab | CR√çTICA | Nuevo: `WebsitePageEditor.tsx` | ‚è≥ |
| **UI-003** | Registrar tipo 'website-page' en DynamicContainer | ALTA | `DynamicContainer.tsx` | ‚è≥ |
| **UI-004** | Click en p√°gina abre tab en DynamicContainer | ALTA | `WebsiteBuilderPanel.tsx`, `panelStore.ts` | ‚è≥ |

**Arquitectura Correcta:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ActivityBar ‚îÇ     Sidebar      ‚îÇ        DynamicContainer         ‚îÇ
‚îÇ  [Globe] ‚Üê‚îÄ‚îÄ‚îÇ Website Builder  ‚îÇ  Tab: p√°gina seleccionada       ‚îÇ
‚îÇ             ‚îÇ P√ÅGINAS      +   ‚îÇ  # Bienvenido a...              ‚îÇ
‚îÇ             ‚îÇ ‚îú‚îÄ Harold Ord√≥√±ez‚îÇ  [Guardar] [Vista previa]       ‚îÇ
‚îÇ             ‚îÇ ‚îî‚îÄ Servicios     ‚îÇ                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Criterios de √âxito:**
- [ ] Sidebar muestra solo lista de p√°ginas y acciones globales
- [ ] Click en p√°gina abre tab en DynamicContainer
- [ ] Editor de p√°gina funciona en tab
- [ ] M√∫ltiples p√°ginas pueden estar abiertas como tabs
- [ ] Guardar p√°gina funciona correctamente

---

### Hito 37: Rutas P√∫blicas de Sitios Web (Karen) - CR√çTICO

**Objetivo:** Las URLs p√∫blicas de sitios web (`/karen`, `/panaderia`, etc.) deben ser accesibles SIN autenticaci√≥n.

**Duraci√≥n:** 0.5 semanas

**Contexto:** Actualmente `http://localhost:5177/karen` redirige a login porque el frontend React intercepta todas las rutas. El backend API ya tiene la l√≥gica para servir sitios est√°ticos.

**Problema Ra√≠z:** `App.tsx` redirige `/*` a login si no est√° autenticado, sin excepci√≥n para rutas p√∫blicas.

| ID | Descripci√≥n | Prioridad | Archivos Afectados | Estado |
|----|-------------|-----------|-------------------|--------|
| **PUB-001** | Detectar rutas p√∫blicas en App.tsx | CR√çTICA | `App.tsx` | ‚è≥ |
| **PUB-002** | Crear componente PublicSitePage o proxy | CR√çTICA | Nuevo o `vite.config.ts` | ‚è≥ |
| **PUB-003** | Verificar que sitios se sirven correctamente | ALTA | Testing manual | ‚è≥ |

**Opci√≥n Recomendada: Proxy en Vite**
```typescript
// vite.config.ts
server: {
  proxy: {
    '^/[a-zA-Z0-9_-]+$': {
      target: 'http://localhost:3000',
      changeOrigin: true,
    },
  },
}
```

**Criterios de √âxito:**
- [ ] `http://localhost:5177/karen` muestra el sitio sin login
- [ ] Usuario no autenticado puede ver sitios p√∫blicos
- [ ] Rutas de la app (`/login`, `/settings`) siguen funcionando

---

### Hito 38: Correcci√≥n de Guardado de P√°ginas (Karen) - ALTO

**Objetivo:** Corregir el error "Failed to save" en WebsiteBuilderPanel.

**Duraci√≥n:** 0.5 semanas

| ID | Descripci√≥n | Prioridad | Archivos Afectados | Estado |
|----|-------------|-----------|-------------------|--------|
| **SAVE-001** | Diagnosticar causa del error de guardado | ALTA | `WebsiteBuilderPanel.tsx`, API logs | ‚è≥ |
| **SAVE-002** | Verificar que accountId es correcto en request | ALTA | `WebsiteBuilderPanel.tsx` | ‚è≥ |
| **SAVE-003** | Agregar manejo de errores detallado | MEDIA | `WebsiteBuilderPanel.tsx` | ‚è≥ |

**Criterios de √âxito:**
- [ ] Guardar p√°gina funciona correctamente
- [ ] Errores muestran mensaje espec√≠fico
- [ ] accountId en request coincide con cuenta activa

---

### Hito 34: Verificaci√≥n de Funcionalidad Real (Anti-Mock) - CR√çTICO

**Objetivo:** Garantizar que TODAS las funcionalidades implementadas son reales y funcionales, NO mocks ni placeholders.

**Duraci√≥n estimada:** 1 semana

**Prioridad:** CR√çTICA (errores cr√≠ticos en producci√≥n)

**Referencia:** Auditor√≠a de c√≥digo - 19 errores encontrados

| ID | Tarea | Prioridad | Verificaci√≥n | Estado |
|----|-------|-----------|--------------|--------|
| **VER-001** | AccountSwitcher cambia cuenta REAL | CR√çTICA | Console log muestra cambio de accountId Y selectedAccountId | ‚è≥ |
| **VER-002** | Cambio de cuenta recarga extensiones | CR√çTICA | Globe aparece/desaparece seg√∫n extensiones de la cuenta | ‚è≥ |
| **VER-003** | useExtensions carga datos de API | CR√çTICA | Console log muestra respuesta de `/extensions/installed/:accountId` | ‚è≥ |
| **VER-004** | ActivityBar muestra extensiones din√°micas | CR√çTICA | Globe visible cuando cuenta tiene @fluxcore/website-builder | ‚è≥ |
| **VER-005** | WebsiteBuilderPanel carga o muestra error | CR√çTICA | No spinner infinito, muestra estado real | ‚è≥ |
| **VER-006** | AccountsSection muestra cuentas reales | CR√çTICA | Lista cuentas de DB, no array vac√≠o | ‚è≥ |

**Criterios de Verificaci√≥n Obligatorios:**

```typescript
// VER-001: AccountSwitcher debe sincronizar AMBOS stores
const handleSelectAccount = (accountId: string) => {
  console.log('[AccountSwitcher] Selecting:', accountId);
  setActiveAccount(accountId);  // accountStore
  useUIStore.getState().setSelectedAccount(accountId);  // uiStore - CR√çTICO
  console.log('[AccountSwitcher] Verified uiStore.selectedAccountId:', 
    useUIStore.getState().selectedAccountId);
};

// VER-002: useExtensions debe reaccionar a cambio de accountId
useEffect(() => {
  console.log('[useExtensions] accountId changed to:', accountId);
  if (accountId) loadInstalled();
}, [accountId]);

// VER-003: Verificar respuesta de API
const result = await response.json();
console.log('[useExtensions] API response:', result);
console.log('[useExtensions] Extensions with UI:', 
  result.data?.filter(i => i.manifest?.ui?.sidebar));

// VER-004: ActivityBar debe mostrar extensiones din√°micas
console.log('[ActivityBar] installations:', installations);
console.log('[ActivityBar] extensionActivities:', extensionActivities);
```

**Pruebas Manuales Requeridas:**

1. **Login como harvan@hotmail.es**
2. **Abrir DevTools Console (F12)**
3. **Verificar logs de carga inicial:**
   - `[useExtensions] Loading installations for account: 842e8ee6-...`
   - `[useExtensions] Extensions with UI: [{...website-builder...}]`
4. **Click en AccountSwitcher ‚Üí Seleccionar "Karen"**
5. **Verificar logs de cambio:**
   - `[AccountSwitcher] Selecting: 49626618-...`
   - `[useExtensions] accountId changed to: 49626618-...`
6. **Verificar que Globe DESAPARECE** (Karen no tiene website-builder)
7. **Click en AccountSwitcher ‚Üí Seleccionar "Harold Ord√≥√±ez"**
8. **Verificar que Globe APARECE** (harvan tiene website-builder)

**Datos de Referencia (DB):**
```sql
-- harvan_mj30hgj0 tiene: @fluxcore/website-builder (con Globe), @fluxcore/fluxcore
-- karen tiene: @fluxcore/fluxcore (sin UI)
```

**Prohibiciones:**
- ‚ùå NO marcar como completado sin verificaci√≥n manual
- ‚ùå NO usar datos mock en ning√∫n componente
- ‚ùå NO asumir que "funciona" sin ver logs en consola
- ‚ùå NO ignorar errores silenciosos

---

## Cronograma Actualizado

```
Semana 31:    Hito 27 - Chat Robustness & UX
Semana 32-33: Hito 28 - Security Hardening
Semana 34:    Hito 29 - Performance & Optimization
Semana 35:    Hito 30 - Monitoring & Observability
Semana 36:    Hito 31 - Frontend Error Fixes
Semana 36.5:  Hito 32 - Chat Layout & UX Fixes
Semana 37.5:  Hito 33 - Mock Elements Cleanup
Semana 38:    Hito 34 - Verificaci√≥n de Funcionalidad Real (Anti-Mock) ‚ö†Ô∏è CR√çTICO

--- CORRECCIONES CR√çTICAS (Auditor√≠a 2024-12-12) ---
Semana 39:    Hito 35 - Arquitectura de Cambio de Cuenta Global ‚ö†Ô∏è CR√çTICO
Semana 39.5:  Hito 36 - Arquitectura UI Can√≥nica (WebsiteBuilderPanel) ‚ö†Ô∏è CR√çTICO
Semana 40:    Hito 37 - Rutas P√∫blicas de Sitios Web (Karen) ‚ö†Ô∏è CR√çTICO
Semana 40.5:  Hito 38 - Correcci√≥n de Guardado de P√°ginas ‚ö†Ô∏è ALTO

Total adicional: ~10 semanas
Total proyecto: ~40 semanas
```

---

## Plan de Correcci√≥n Ordenado por Dependencias

### Orden de Ejecuci√≥n Recomendado

Los hitos 35-38 deben ejecutarse en el siguiente orden debido a sus dependencias:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  FASE 1: FUNDAMENTOS (Semana 39)                                ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ Hito 35: Arquitectura de Cambio de Cuenta Global        ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - ACC-001: Unificar stores (accountStore = verdad)      ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - ACC-002: switchAccount() actualiza TODO               ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - ACC-003 a ACC-007: Recargar datos por cuenta          ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                              ‚Üì                                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  FASE 2: UI CAN√ìNICA (Semana 39.5)                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ Hito 36: WebsiteBuilderPanel UI                         ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - UI-001: Separar Sidebar (lista) y Tab (editor)        ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - UI-002: Crear WebsitePageEditor                       ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - UI-003: Registrar en DynamicContainer                 ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                              ‚Üì                                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  FASE 3: FUNCIONALIDAD (Semana 40)                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ Hito 38: Correcci√≥n de Guardado                         ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - SAVE-001: Diagnosticar error                          ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - SAVE-002: Verificar accountId correcto                ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - SAVE-003: Manejo de errores                           ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                              ‚Üì                                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  FASE 4: ACCESO P√öBLICO (Semana 40.5)                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ Hito 37: Rutas P√∫blicas                                 ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - PUB-001: Detectar rutas p√∫blicas                      ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - PUB-002: Proxy en Vite o componente                   ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - PUB-003: Testing                                      ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Justificaci√≥n del Orden

1. **Hito 35 PRIMERO**: Es la base de todo. Sin cuentas funcionando correctamente, nada m√°s funciona.
2. **Hito 36 SEGUNDO**: Requiere que las cuentas funcionen para mostrar datos correctos.
3. **Hito 38 TERCERO**: El guardado depende de tener el accountId correcto (Hito 35) y la UI correcta (Hito 36).
4. **Hito 37 √öLTIMO**: Es independiente pero se beneficia de que todo lo dem√°s funcione.

### Archivos Clave a Modificar

| Archivo | Hitos | Cambios |
|---------|-------|---------|
| `accountStore.ts` | 35 | Fuente √∫nica de verdad, switchAccount() |
| `uiStore.ts` | 35 | Eliminar duplicaci√≥n de accounts |
| `AccountSwitcher.tsx` | 35 | Llamar switchAccount() |
| `WebsiteBuilderPanel.tsx` | 36, 38 | Separar lista/editor, fix guardado |
| `WebsitePageEditor.tsx` | 36 | NUEVO: Editor como tab |
| `DynamicContainer.tsx` | 36 | Registrar tipo website-page |
| `App.tsx` | 37 | Rutas p√∫blicas |
| `vite.config.ts` | 37 | Proxy para sitios p√∫blicos |
| `WelcomeView.tsx` | 35 | Usar cuenta activa para saludo |
| `ConversationsList.tsx` | 35 | Recargar al cambiar cuenta |
| `ContactsList.tsx` | 35 | Recargar al cambiar cuenta |
| `useExtensions.ts` | 35 | Recargar al cambiar cuenta |

---

### Hito MA: Multi-Account Isolation Fix (CR√çTICO - Bug Activo)

**Fecha:** 2024-12-13  
**Prioridad:** CR√çTICA - Bug de producci√≥n  
**Duraci√≥n estimada:** 1 d√≠a  
**Estado:** ‚úÖ COMPLETADO (2024-12-13)

### Problema Detectado

Al cambiar de cuenta, los datos de una cuenta contaminan a la otra:
- Conversaciones de Harold aparecen en Karen
- Eliminar en Karen elimina en Harold
- Crear en Karen aparece en Harold

### Causa Ra√≠z (5 puntos de falla)

1. **Backend devuelve datos de TODAS las cuentas del usuario** - No filtra por `accountId` espec√≠fico
2. **Frontend API no pasa `accountId`** - Las llamadas no especifican qu√© cuenta
3. **`hasLoaded` flags no se resetean** - Componentes no recargan al cambiar cuenta
4. **`resetAccountData` es insuficiente** - Solo limpia conversations, no notifica componentes
5. **`panelStore` persiste tabs** - Tabs de chat de otra cuenta permanecen abiertos

---

### Hito MA-1: Backend Account Isolation ‚úÖ COMPLETADO

| ID | Tarea | Archivo | Cambio | Estado |
|----|-------|---------|--------|--------|
| MA-101 | Agregar m√©todo `getConversationsByAccountId` | `conversation.service.ts` | Nuevo m√©todo que filtra por accountId espec√≠fico | ‚úÖ |
| MA-102 | Modificar ruta GET /conversations | `conversations.routes.ts` | Recibir `?accountId=X` query param | ‚úÖ |
| MA-103 | Agregar m√©todo `getRelationshipsByAccountId` | `relationship.service.ts` | Ya existe, solo verificar | ‚úÖ |
| MA-104 | Modificar ruta GET /relationships | `relationships.routes.ts` | Recibir `?accountId=X` query param | ‚úÖ |
| MA-105 | Validar ownership de accountId | Ambas rutas | Verificar que accountId pertenece al usuario | ‚úÖ |

**Criterio de aceptaci√≥n:**
- ‚úÖ `GET /conversations?accountId=X` devuelve SOLO conversaciones de esa cuenta
- ‚úÖ `GET /relationships?accountId=X` devuelve SOLO relaciones de esa cuenta
- ‚úÖ Error 403 si accountId no pertenece al usuario autenticado

---

### Hito MA-2: Frontend API Account Filtering ‚úÖ COMPLETADO

| ID | Tarea | Archivo | Cambio | Estado |
|----|-------|---------|--------|--------|
| MA-201 | Modificar `getConversations(accountId)` | `api.ts` | Pasar accountId como query param | ‚úÖ |
| MA-202 | Modificar `getRelationships(accountId)` | `api.ts` | Pasar accountId como query param | ‚úÖ |
| MA-203 | Actualizar ConversationsList | `ConversationsList.tsx` | Pasar selectedAccountId a API | ‚úÖ |
| MA-204 | Actualizar ContactsList | `ContactsList.tsx` | Pasar selectedAccountId a API | ‚úÖ |

**Criterio de aceptaci√≥n:**
- ‚úÖ Todas las llamadas API incluyen accountId
- ‚úÖ Sin errores de consola relacionados con datos

---

### Hito MA-3: State Reset on Account Switch ‚úÖ COMPLETADO

| ID | Tarea | Archivo | Cambio | Estado |
|----|-------|---------|--------|--------|
| MA-301 | Mejorar `resetAccountData` | `uiStore.ts` | Emitir evento de reset | ‚úÖ |
| MA-302 | Reset `hasLoaded` en ContactsList | `ContactsList.tsx` | Escuchar selectedAccountId y resetear | ‚úÖ |
| MA-303 | Reset panelStore en cambio | `useContextRefresh.ts` | Llamar `resetLayout()` | ‚úÖ |
| MA-304 | Limpiar tabs de otra cuenta | `panelStore.ts` | Cerrar tabs al cambiar cuenta | ‚úÖ |

**Criterio de aceptaci√≥n:**
- ‚úÖ Al cambiar cuenta, todos los componentes recargan datos frescos
- ‚úÖ Tabs de chat de cuenta anterior se cierran
- ‚úÖ No hay datos residuales de cuenta anterior

---

### Hito MA-4: Verificaci√≥n y Testing ‚úÖ COMPLETADO

| ID | Tarea | Descripci√≥n | Estado |
|----|-------|-------------|--------|
| MA-401 | Test manual: Cambio Karen ‚Üí Harold | Verificar que Harold ve SOLO sus datos | üîÑ Pendiente verificaci√≥n manual |
| MA-402 | Test manual: Cambio Harold ‚Üí Karen | Verificar que Karen ve SOLO sus datos | üîÑ Pendiente verificaci√≥n manual |
| MA-403 | Test: Crear conversaci√≥n en Karen | Verificar que NO aparece en Harold | üîÑ Pendiente verificaci√≥n manual |
| MA-404 | Test: Eliminar conversaci√≥n en Harold | Verificar que NO afecta a Karen | üîÑ Pendiente verificaci√≥n manual |
| MA-405 | Build de producci√≥n | Verificar que compila sin errores | ‚úÖ |

**Criterio de aceptaci√≥n:**
- ‚úÖ Cuentas son unidades completamente aisladas
- ‚úÖ CRUD en una cuenta no afecta a otra
- ‚úÖ Sin contaminaci√≥n de datos entre cuentas

---

### Gu√≠a de Verificaci√≥n Manual (Post-Implementaci√≥n)

```
1. Iniciar sesi√≥n con usuario que tenga 2+ cuentas (ej: Karen y Harold)
2. En cuenta Karen:
   - Verificar lista de conversaciones (debe estar vac√≠a o solo las de Karen)
   - Crear nueva conversaci√≥n con un contacto
   - Verificar que aparece en la lista
3. Cambiar a cuenta Harold:
   - Verificar lista de conversaciones (NO debe tener la conversaci√≥n de Karen)
   - Las conversaciones deben ser SOLO las de Harold
4. Volver a cuenta Karen:
   - La conversaci√≥n creada debe seguir ah√≠
   - NO debe haber datos de Harold
5. En cuenta Harold, eliminar una conversaci√≥n:
   - Verificar que se elimina
6. Cambiar a cuenta Karen:
   - Verificar que las conversaciones de Karen NO fueron afectadas
```


---

## Hito UI-5: ChatView Layout & Auto-Scroll (CR√çTICO - UX)

**Fecha:** 2025-12-13  
**Prioridad:** ALTA (UX / Usabilidad)  
**Duraci√≥n estimada:** 0.5 d√≠a  
**Estado:** ‚úÖ COMPLETADO (2025-12-13)

| ID | Tarea | Archivo | Cambio | Estado |
|----|-------|---------|--------|--------|
| UI-501 | Fijar input al fondo | `ChatView.tsx` | Layout `h-full flex-col`, input `flex-shrink-0` | ‚úÖ |
| UI-502 | Scroll interno correcto en mensajes | `ChatView.tsx` | Mensajes `flex-1 min-h-0 overflow-y-auto` (sin `maxHeight` por window) | ‚úÖ |
| UI-503 | Auto-scroll controlado | `ChatView.tsx` | Auto-scroll solo si usuario est√° en el fondo; always bottom al abrir conversaci√≥n | ‚úÖ |
| UI-504 | Evitar que cards (IA) empujen el input | `ChatView.tsx` | Mover sugerencias dentro del √°rea scrolleable | ‚úÖ |
| UI-505 | Refuerzo de l√≠mites de alto en containers | `DynamicContainer.tsx` | Agregar `min-h-0` al √°rea de contenido | ‚úÖ |
| UI-506 | Scroll inicial correcto en lista de conversaciones | `ConversationsList.tsx` | Reset scrollTop al cargar por cuenta (evitar quedar abajo) | ‚úÖ |

**Criterio de aceptaci√≥n:**
- ‚úÖ El input del chat permanece fijo en la parte inferior en todo momento
- ‚úÖ La lista de mensajes nunca empuja el input (solo scrollea internamente)
- ‚úÖ Al abrir una conversaci√≥n, se posiciona abajo autom√°ticamente
- ‚úÖ Si el usuario scrollea hacia arriba, NO se fuerza auto-scroll al llegar mensajes nuevos
- ‚úÖ No hay doble scroll ni desbordes fuera del container
- ‚úÖ La lista de conversaciones (sidebar) no queda scrolleada al final al cargar

### Gu√≠a de Verificaci√≥n Manual
```
1. Abrir cualquier chat con varios mensajes
2. Enviar 5+ mensajes consecutivos
   - Verificar que el input no se mueve hacia abajo
   - Verificar que el scroll ocurre en el √°rea de mensajes
3. Scrollear manualmente hacia arriba (leer mensajes antiguos)
4. Recibir o enviar un mensaje nuevo
   - Verificar que NO ‚Äúsalta‚Äù autom√°ticamente hacia abajo
5. Scrollear hacia abajo hasta el final
6. Enviar/recibir un mensaje
   - Verificar que mantiene el scroll pegado al final
```

---

## Hito UI-6: ChatView WhatsApp-like Message Growth (Anclaje al fondo)

**Fecha:** 2025-12-13  
**Prioridad:** ALTA (UX / Usabilidad)  
**Duraci√≥n estimada:** 0.25 d√≠a  
**Estado:** ‚úÖ COMPLETADO (2025-12-13)

| ID | Tarea | Archivo | Cambio | Estado |
|----|-------|---------|--------|--------|
| UI-601 | Anclar mensajes al fondo cuando hay pocos | `ChatView.tsx` | Wrapper interno `min-h-full flex flex-col justify-end` para que los mensajes queden cerca del input | ‚úÖ |
| UI-602 | Mantener empty-state centrado | `ChatView.tsx` | Empty state ocupa alto completo y no queda ‚Äúpegado abajo‚Äù | ‚úÖ |
| UI-603 | Scroll al abrir conversaci√≥n post-render | `ChatView.tsx` | Scroll al fondo post-render al abrir conversaci√≥n, sin forzar cuando usuario lee hist√≥rico | ‚úÖ |
| UI-604 | Regression: cards IA no empujan input | `ChatView.tsx` | Confirmar que sugerencias IA siguen dentro del √°rea scrolleable | ‚úÖ |
| UI-605 | Build de producci√≥n | Monorepo | `bun run build` sin errores | ‚úÖ |

**Criterio de aceptaci√≥n:**
- ‚úÖ Con pocos mensajes, la conversaci√≥n queda visualmente ‚Äúpegada‚Äù al fondo (cerca del input), sin un vac√≠o grande debajo
- ‚úÖ Los mensajes nuevos aparecen al final (cerca del input) y la conversaci√≥n se percibe que ‚Äúcrece hacia arriba‚Äù
- ‚úÖ Con muchos mensajes, el scroll funciona normal (hist√≥rico arriba, recientes abajo)
- ‚úÖ Al abrir una conversaci√≥n, el usuario aterriza en el fondo (√∫ltimo mensaje visible)
- ‚úÖ Si el usuario scrollea hacia arriba, NO se fuerza auto-scroll al llegar mensajes nuevos
- ‚úÖ `bun run build` compila sin errores

---

### Hito FC-RUNTIME-1: Correcci√≥n Estructural (Data Layer) - CR√çTICO

**Objetivo:** Adaptar el esquema de BD para soportar composici√≥n real (N:M) de instrucciones y vector stores por asistente.

**Duraci√≥n estimada:** 0.5 d√≠as

**Contexto:** El esquema actual `fluxcore_assistants` solo permite 1 instrucci√≥n y 1 vector store, lo cual bloquea la arquitectura de composici√≥n por referencia definida en el TOTEM.

| ID | Tarea | Prioridad | Dependencia | Descripci√≥n |
|----|-------|-----------|-------------|-------------|
| **FCR-101** | Refactor Schema Assistants | ALTA | - | Eliminar FKs √∫nicas en `fluxcore_assistants` |
| **FCR-102** | Crear Schema AssistantInstructions | ALTA | FCR-101 | Tabla intermedia con order y version |
| **FCR-103** | Crear Schema AssistantVectorStores | ALTA | FCR-101 | Tabla intermedia con access_mode |
| **FCR-104** | Generar y Aplicar Migraci√≥n | CR√çTICA | FCR-103 | `drizzle-kit generate` + `push` |

**Criterios de √âxito:**
- [ ] BD permite asignar m√∫ltiples instrucciones a un asistente
- [ ] BD permite asignar m√∫ltiples vector stores a un asistente
- [ ] Migraci√≥n ejecutada sin p√©rdida de datos (si aplica)

---

### Hito FC-RUNTIME-2: FluxCore Service "Brain" (Service Layer)

**Objetivo:** Implementar la l√≥gica de ensamblaje de prompts din√°micos basada en la composici√≥n del asistente.

**Duraci√≥n estimada:** 1 semana

| ID | Tarea | Prioridad | Dependencia | Descripci√≥n |
|----|-------|-----------|-------------|-------------|
| **FCR-201** | Implementar `getAssistantComposition` | ALTA | FCR-104 | Fetch deep de asistente + refs |
| **FCR-202** | Implementar `PromptBuilder` compuesto | ALTA | FCR-201 | Concatenar instrucciones ordenadas |
| **FCR-203** | Implementar `resolveActiveAssistant` | ALTA | FCR-201 | Determinar qu√© asistente responde |
| **FCR-204** | Exponer endpoint de debug de composici√≥n | MEDIA | FCR-203 | `/api/fluxcore/debug/:assistantId` |

**Criterios de √âxito:**
- [ ] Servicio retorna prompt unificado de m√∫ltiples instrucciones
- [ ] Contexto de Vector Store se inyecta correctamente (stub)

---

### Hito FC-RUNTIME-3: Migraci√≥n de FluxCore (Extension Layer)

**Objetivo:** Reemplazar la l√≥gica legacy de `extensions/fluxcore` para usar el nuevo servicio FluxCore.

**Duraci√≥n estimada:** 0.5 semanas

| ID | Tarea | Prioridad | Dependencia | Descripci√≥n |
|----|-------|-----------|-------------|-------------|
| **FCR-301** | Actualizar `FluxCoreExtension` | ALTA | FCR-203 | Usar `fluxcore.service` en `onMessage` |
| **FCR-302** | Eliminar l√≥gica legacy de config local | MEDIA | FCR-301 | Limpiar c√≥digo antiguo |
| **FCR-303** | Verificar flujo E2E | CR√çTICA | FCR-301 | Chat responde usando asistente DB |

**Criterios de √âxito:**
- [ ] El bot responde seg√∫n las instrucciones definidas en DB (no en c√≥digo)
- [ ] FluxCore opera puramente como interfaz del Runtime

---

## Hito FC-UI-UPDATE: Frontend de Composici√≥n

**Objetivo:** Actualizar la UI de Asistentes para permitir selecci√≥n m√∫ltiple de assets.

**Duraci√≥n estimada:** 0.5 semanas

| ID | Tarea | Prioridad | Dependencia | Descripci√≥n |
|----|-------|-----------|-------------|-------------|
| **FCU-401** | Crear `MultiAssetSelector` | MEDIA | - | Componente UI gen√©rico |
| **FCU-402** | Actualizar `AssistantsView` | ALTA | FCR-104 | Usar selectores m√∫ltiples |
| **FCU-403** | Implementar Drag & Drop de instrucciones | BAJA | FCU-402 | Reordenar prioridades |

**Criterios de √âxito:**
- [ ] UI permite agregar/quitar m√∫ltiples instrucciones
- [ ] UI guarda correctamente la composici√≥n en nuevas tablas

```

### Hito VS-ALIGN: Vector Store Alignment with OpenAI

**Estado**: Pendiente
**Fecha estimada**: 2026-02-07
**Duraci√≥n**: 2 semanas

**Objetivos**:
1. Lograr paridad completa con OpenAI Vector Store API
2. Eliminar archivos huerfanos mediante cascadas
3. Implementar pol√≠ticas de expiraci√≥n compatibles
4. Unificar l√≥gica de eliminaci√≥n local/remota

**Tareas**:
- VS-ALIGN-110: Servicio unificado de eliminaci√≥n con limpieza en cascada
- VS-ALIGN-111: Capa de conversi√≥n de pol√≠ticas de expiraci√≥n (d√≠as ‚Üî duraci√≥n)
- VS-ALIGN-112: Mecanismo de sincronizaci√≥n de estado
- VS-ALIGN-113: UI de colecci√≥n de archivos en VectorStoreView
- VS-ALIGN-114: Actualizaciones documentales
